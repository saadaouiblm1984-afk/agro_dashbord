# دليل إصلاح مشاكل المزامنة مع Google Sheets

## المشاكل التي تم إصلاحها

### 1. **عدم تطابق أسماء الأوراق**
- **المشكلة**: كان الكود يستخدم `'category'` بينما Google Sheets يستخدم `'categories'`
- **الحل**: تم توحيد الأسماء لاستخدام `'categories'` في كل الأماكن

### 2. **مشاكل في معالجة استجابة JSON**
- **المشكلة**: Google Apps Script كان يرجع بيانات غير متسقة
- **الحل**: تم تحسين معالجة الاستجابات لدعم كل من JSON والنص العادي

### 3. **أخطاء في الاتصال والمصادقة**
- **المشكلة**: عدم وجود معالجة مناسبة للأخطاء ومهلة الاتصال
- **الحل**: تم إضافة تحسينات في معالجة الأخطاء وزيادة مهلة الاتصال

## خطوات التثبيت

### الخطوة 1: تحديث Google Apps Script

1. افتح Google Sheets
2. اذهب إلى `Extensions > Apps Script`
3. استبدل الكود الحالي بالكود الموجود في `fixed_google_apps_script.js`
4. احفظ المشروع (Ctrl+S)
5. انشر كـ Web App:
   - `Deploy > New Deployment`
   - اختر `Web app`
   - `Execute as`: Me
   - `Who has access`: Anyone
   - انشر وانسخ رابط Web App

### الخطوة 2: تحديث ملفات المشروع

تم تحديث الملفات التالية تلقائياً:
- `google_sheets_integration.js` - تم إصلاح مشاكل المزامنة
- `fixed_google_apps_script.js` - كود Google Apps Script المُحسَّن

### الخطوة 3: إعداد الأوراق في Google Sheets

تأكد من وجود الأوراق التالية بالأسماء المحددة:

```
products
categories
orders
order_items
customers
promotions
```

### الخطوة 4: اختبار الاتصال

1. افتح لوحة التحكم
2. اذهب إلى صفحة إعداد Google Sheets
3. أدخل رابط Web App ومعرف الجدول
4. اضغط على "اختبار الاتصال"
5. إذا نجح الاتصال، اضغط على "حفظ الإعدادات"

## ميزات جديدة

### 1. **معالجة محسنة للأخطاء**
- رسائل خطأ واضحة ومفصلة
- اكتشاف تلقائي لمشاكل CORS والشبكة
- مهلة اتصال موسعة (15 ثانية)

### 2. **كاش ذكي**
- تخزين مؤقت للبيانات لمدة 5 دقائق
- مسح تلقائي للكاش عند تحديث البيانات
- تحسين الأداء وتقليل الطلبات

### 3. **توافق أفضل**
- دعم كل من استجابات JSON والنص
- معالجة خاصة للفئات (categories)
- توافق مع الإصدارات القديمة

## استكشاف الأخطاء

### مشكلة: "فشل الاتصال"
**الحلول:**
1. تحقق من رابط Web App
2. تأكد من أن Google Apps Script منشور بـ "Anyone" access
3. تحقق من اتصال الإنترنت

### مشكلة: "CORS error"
**الحلول:**
1. أعد نشر Google Apps Script
2. تأكد من إعدادات النشر الصحيحة
3. تحقق من أن الرابط صحيح

### مشكلة: "Connection timeout"
**الحلول:**
1. تحقق من سرعة الإنترنت
2. جرب الاختبار مرة أخرى
3. تحقق من أن Google Apps Script يعمل

## اختبار سريع

لاختبار المزامنة:

```javascript
// في console المتصفح
testGoogleSheetsConnection().then(result => {
    console.log('Test result:', result);
});
```

لمزامنة البيانات:

```javascript
// في console المتصفح
syncGoogleSheets().then(() => {
    console.log('Sync completed');
});
```

## ملاحظات هامة

1. **الأمان**: غيّر `API_SECRET` في Google Apps Script إلى قيمة آمنة
2. **الصلاحيات**: تأكد من أن Google Sheets مشاركة مع "Anyone with link"
3. **النشر**: بعد كل تعديل على Google Apps Script، أعد النشر
4. **التحديث**: يتم تحديث البيانات تلقائياً كل 5 دقائق

## الدعم

إذا واجهت مشاكل:
1. تحقق من console المتصفح للأخطاء
2. تأكد من إعدادات Google Apps Script
3. تحقق من أسماء الأوراق في Google Sheets
4. اختبر الاتصال يدوياً باستخدام `testGoogleSheetsConnection()`
