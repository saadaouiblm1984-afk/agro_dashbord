<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم الإدارية</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2C3E50;
            --secondary-color: #3498DB;
            --success-color: #27AE60;
            --warning-color: #F39C12;
            --danger-color: #E74C3C;
            --light-color: #ECF0F1;
            --dark-color: #2C3E50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .sidebar {
            background: var(--primary-color);
            min-height: 100vh;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            right: 0;
            z-index: 1000;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            color: white;
            padding: 12px 4px;
            margin: 2px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            position: relative;
        }
        
        .sidebar .nav-link i {
            font-size: 1.6rem;
            display: block;
            margin-bottom: 4px;
        }
        
        .sidebar .nav-link span {
            font-size: 0.65rem;
            display: block;
            line-height: 1;
        }
        
        .sidebar .nav-link .badge-count {
            position: absolute;
            top: 3px;
            right: 3px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            font-size: 0.6rem;
            padding: 1px 4px;
            min-width: 16px;
            text-align: center;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: var(--secondary-color);
            transform: translateX(5px);
        }
        
        .main-content {
            background: white;
            min-height: 100vh;
            margin-right: 8.333333%; /* Same as col-md-1 */
            padding: 20px;
            border-radius: 20px 0 0 20px;
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 0 2px;
        }
        
        .btn-icon i {
            font-size: 1rem;
            margin: 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border-left: 4px solid;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .stat-card.primary { border-left-color: var(--primary-color); }
        .stat-card.success { border-left-color: var(--success-color); }
        .stat-card.warning { border-left-color: var(--warning-color); }
        .stat-card.danger { border-left-color: var(--danger-color); }
        .stat-card.info { border-left-color: var(--secondary-color); }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .recent-orders {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .category-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .category-image {
            height: 180px;
            object-fit: cover;
        }
        
        .order-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .order-item:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .status-pending { background: #FFF3CD; color: #856404; }
        .status-processing { background: #CCE5FF; color: #004085; }
        .status-shipped { background: #D1ECF1; color: #0C5460; }
        .status-delivered { background: #D4EDDA; color: #155724; }
        .status-cancelled { background: #F8D7DA; color: #721C24; }
        
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .product-card-v2 {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .product-card-v2:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .product-card-v2-image-wrapper {
            position: relative;
            height: 150px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .product-card-v2-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: filter 0.3s ease;
        }

        .product-status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.75rem;
        }

        .product-card-v2-actions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .product-card-v2-image-wrapper:hover .product-card-v2-actions {
            opacity: 1;
        }

        .product-card-v2-image-wrapper:hover .product-card-v2-image {
            filter: blur(2px) brightness(0.8);
        }

        .product-card-v2-body {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .product-category {
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .product-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            height: 40px; /* 2 lines */
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            flex-grow: 1;
        }

        .product-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: auto;
        }

        .product-meta span:first-child {
            color: var(--primary-color);
        }

        .product-card-v2-footer {
            padding: 0 15px 15px 15px;
            border-top: 1px solid #f1f1f1;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .product-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .product-image-container {
            width: 100%;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .product-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
        }
        
        .cart-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        .products-section {
            flex: 2;
            min-width: 0;
        }
        
        .cart-section {
            flex: 1;
            min-width: 280px;
            max-width: 380px;
            position: sticky;
            top: 20px;
            bottom: 20px;
            transform: none;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .cart-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .products-section {
                flex: 1;
                min-width: 100%;
            }
            
            .cart-section {
                flex: 1;
                min-width: 100%;
                max-width: 100%;
                position: static;
                top: auto;
            }
        }
        
        /* Full height layout */
        .page-content {
            min-height: calc(100vh - 200px);
        }
        
        #cart .page-content {
            min-height: calc(100vh - 150px);
        }
        
        .cart-container {
            min-height: calc(100vh - 250px);
        }
        
        .cart-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .cart-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px;
            font-size: 14px;
        }
        
        .quantity-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
            background-color: #fff;
        }
        
        .cart-item .btn-outline-danger:hover {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }
        
        /* Cart section improvements */
        .cart-section {
            max-height: none;
            height: calc(100vh - 40px);
            overflow-y: auto;
            transition: none;
            margin-bottom: 0;
        }
        
        .cart-section:hover {
            max-height: none;
            height: calc(100vh - 40px);
        }
        
        /* Sticky totals section */
        .cart-card {
            position: sticky;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .cart-card h5 {
            color: white;
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 20px;
        }
        
        .total-section {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .total-section .d-flex {
            color: white;
            font-size: 0.95em;
            margin-bottom: 8px;
        }
        
        .total-section strong {
            color: #FFD700;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .total-section .text-success {
            color: #00FF88 !important;
            font-size: 1.3em;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0,255,136,0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                text-shadow: 0 0 10px rgba(0,255,136,0.5);
            }
            to {
                text-shadow: 0 0 20px rgba(0,255,136,0.8), 0 0 30px rgba(0,255,136,0.6);
            }
        }
        
        .total-section .form-control {
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(255,255,255,0.3);
            color: #333;
            font-size: 0.9em;
            padding: 10px 15px;
        }
        
        .total-section .form-control:focus {
            background: white;
            border-color: #FFD700;
            box-shadow: 0 0 0 3px rgba(255,215,0,0.3);
        }
        
        .total-section .btn {
            font-weight: bold;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .total-section .checkout-btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }
        
        .total-section .checkout-btn:hover {
            background: linear-gradient(45deg, #FFA500, #FF8C00);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,215,0,0.4);
        }
        
        .total-section .btn-success {
            background: linear-gradient(45deg, #00FF88, #00CC66);
            color: white;
        }
        
        .total-section .btn-success:hover {
            background: linear-gradient(45deg, #00CC66, #00AA55);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,255,136,0.4);
        }
        
        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
        }
        
        .modal.show {
            display: block;
        }
        
        .modal-dialog {
            position: relative;
            margin: 50px auto;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-dialog-centered {
            display: flex;
            align-items: center;
            min-height: calc(100% - 100px);
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
            padding: 15px 25px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-close:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .cart-section::-webkit-scrollbar {
            width: 6px;
        }
        
        .cart-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .cart-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .cart-section::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Products section in cart */
        .products-section {
            max-height: none;
            overflow-y: visible;
            min-height: 600px;
        }
        
        /* Better product grid layout */
        .products-section .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 10px 0;
        }
        
        /* Smaller product cards in cart */
        .products-section .product-card {
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .products-section .product-card h6 {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .products-section .product-card .product-image-container {
            height: 80px;
        }
        
        .products-section .product-card .product-image {
            height: 80px;
        }
        
        /* Smaller cart items */
        .cart-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .cart-item strong {
            font-size: 0.9em;
        }
        
        .cart-item small {
            font-size: 0.8em;
        }
        
        .cart-item .quantity-controls {
            transform: scale(0.9);
        }
        
        .cart-item .quantity-input {
            width: 50px;
            height: 30px;
            font-size: 0.85em;
        }
        
        .cart-item .quantity-btn {
            width: 25px;
            height: 30px;
            font-size: 0.8em;
        }
        
        .quantity-btn:hover {
            transform: scale(1.1);
        }
        
        .category-filter {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .category-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: white;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .category-btn:hover, .category-btn.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .total-section {
            border-top: 2px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .checkout-btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            background: var(--success-color);
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .checkout-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }
        
        .empty-cart {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        /* Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            max-width: 350px;
        }
        
        .notification {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid var(--success-color);
            animation: slideInRight 0.3s ease;
            position: relative;
        }
        
        .notification.new-order {
            border-right-color: var(--primary-color);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .notification-title {
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .notification-close:hover {
            background: #f0f0f0;
            color: #666;
        }
        
        .notification-body {
            color: #666;
            font-size: 0.9rem;
        }
        
        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        
        .notification-actions button {
            padding: 5px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .notification-btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .notification-btn-primary:hover {
            background: #1a252f;
        }
        
        .notification-btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        .notification-btn-secondary:hover {
            background: #e0e0e0;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .notification.removing {
            animation: slideOutRight 0.3s ease;
        }
        
        /* Orders badge animation */
        .orders-badge-blink {
            animation: blink 1s ease-in-out 3;
        }
        
        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.3; }
        }
        
        /* Sound indicator */
        .sound-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 9998;
        }
        
        .sound-indicator.show {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }
        
        @keyframes fadeInUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-1 sidebar p-0">
                <div class="p-2">
                    <h5 class="text-white mb-3 text-center">
                        <i class="fas fa-tachometer-alt"></i>
                    </h5>
                    <nav class="nav flex-column">
                        <a href="#" class="nav-link active" onclick="showPage('dashboard')" title="الرئيسية">
                            <i class="fas fa-home"></i>
                            <span>الرئيسية</span>
                        </a>
                        <a href="#" class="nav-link" onclick="showPage('products')" title="المنتجات">
                            <i class="fas fa-box"></i>
                            <span>المنتجات</span>
                        </a>
                        <a href="#" class="nav-link" onclick="showPage('cart')" title="سلة التسوق">
                            <i class="fas fa-shopping-cart"></i>
                            <span>السلة</span>
                            <span class="badge-count" id="cartCount">0</span>
                        </a>
                        <a href="#" class="nav-link" onclick="showPage('orders')" title="الطلبات">
                            <i class="fas fa-shopping-bag"></i>
                            <span>الطلبات</span>
                            <span class="badge-count" id="newOrdersCount" style="display: none;">0</span>
                        </a>
                        <a href="#" class="nav-link" onclick="showPage('categories')" title="الأصناف">
                            <i class="fas fa-tags"></i>
                            <span>الأصناف</span>
                        </a>
                        <a href="#" class="nav-link" onclick="toggleNotifications()" title="إيقاف/تشغيل الإشعارات" id="notificationToggle">
                            <i class="fas fa-bell" id="notificationIcon"></i>
                            <span>الإشعارات</span>
                        </a>
                        <a href="google_sheets_setup.html" class="nav-link" target="_blank" title="إعداد Google Sheets">
                            <i class="fas fa-google"></i>
                            <span>إعداد</span>
                        </a>
                    </nav>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-11 main-content p-4">
                <!-- Dashboard Page -->
                <div id="dashboard" class="page-content active">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            نظرة عامة
                        </h2>
                        <div>
                            <button class="btn btn-primary btn-icon" onclick="syncGoogleSheets()" title="مزامنة Google Sheets">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button class="btn btn-info btn-icon" onclick="testGoogleSheetsConnection()" title="اختبار الاتصال">
                                <i class="fas fa-plug"></i>
                            </button>
                            <button class="btn btn-warning btn-icon" onclick="toggleDataSource()" title="تبديل مصدر البيانات">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                            <button class="btn btn-secondary btn-icon" onclick="refreshData()" title="تحديث">
                                <i class="fas fa-refresh"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="stat-card primary">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">إجمالي المنتجات</h6>
                                        <div class="stat-number text-primary" id="totalProducts">0</div>
                                    </div>
                                    <div class="text-primary" style="font-size: 2rem;">
                                        <i class="fas fa-box"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="stat-card success">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">إجمالي الطلبات</h6>
                                        <div class="stat-number text-success" id="totalOrders">0</div>
                                    </div>
                                    <div class="text-success" style="font-size: 2rem;">
                                        <i class="fas fa-shopping-bag"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="stat-card warning">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">الطلبات المعلقة</h6>
                                        <div class="stat-number text-warning" id="pendingOrders">0</div>
                                    </div>
                                    <div class="text-warning" style="font-size: 2rem;">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="stat-card info">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">إجمالي الإيرادات</h6>
                                        <div class="stat-number text-info" id="totalRevenue">0 دج</div>
                                    </div>
                                    <div class="text-info" style="font-size: 2rem;">
                                        <i class="fas fa-dollar-sign"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sales Statistics Boxes -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="stat-card success" style="background: linear-gradient(135deg, #00b09b, #96c93d); color: white; border: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">المبيعات اليوم</h6>
                                        <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: white;" id="todaySales">0</div>
                                        <small style="color: rgba(255,255,255,0.8);">دج</small>
                                    </div>
                                    <div style="font-size: 1.5rem; color: rgba(255,255,255,0.9);">
                                        <i class="fas fa-calendar-day"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="stat-card info" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">المبيعات الأسبوعية</h6>
                                        <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: white;" id="weeklySales">0</div>
                                        <small style="color: rgba(255,255,255,0.8);">دج</small>
                                    </div>
                                    <div style="font-size: 1.5rem; color: rgba(255,255,255,0.9);">
                                        <i class="fas fa-calendar-week"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="stat-card warning" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">المبيعات الشهرية</h6>
                                        <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: white;" id="monthlySales">0</div>
                                        <small style="color: rgba(255,255,255,0.8);">دج</small>
                                    </div>
                                    <div style="font-size: 1.5rem; color: rgba(255,255,255,0.9);">
                                        <i class="fas fa-calendar-alt"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <div class="stat-card primary" style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; border: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">إجمالي المبيعات</h6>
                                        <div class="stat-number" style="font-size: 2rem; font-weight: bold; color: white;" id="totalSales">0</div>
                                        <small style="color: rgba(255,255,255,0.8);">دج</small>
                                    </div>
                                    <div style="font-size: 1.5rem; color: rgba(255,255,255,0.9);">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts and Recent Orders -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="chart-container">
                                <h5 class="mb-3">
                                    <i class="fas fa-chart-line me-2"></i>
                                    إحصائيات المبيعات
                                </h5>
                                <canvas id="salesChart" height="100"></canvas>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-sync me-2"></i>
                                        حالة المزامنة
                                    </h5>
                                    <div id="syncStatus" class="text-center">
                                        <div class="spinner-border spinner-border-sm text-primary mb-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="text-muted">جاري التحقق...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts and Recent Orders -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="chart-container">
                                <h5 class="mb-3">
                                    <i class="fas fa-history me-2"></i>
                                    الطلبات الأخيرة
                                </h5>
                                <div class="recent-orders" id="recentOrders">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">جاري التحميل...</span>
                                        </div>
                                        <p class="mt-2 small">جاري تحميل الطلبات الأخيرة...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="chart-container">
                                <h5 class="mb-3">
                                    <i class="fas fa-chart-line me-2"></i>
                                    إحصائيات المبيعات
                                </h5>
                                <canvas id="salesChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Products Page -->
                <div id="products" class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">
                            <i class="fas fa-box me-2"></i>
                            إدارة المنتجات
                        </h2>
                        <div>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" title="عرض شبكي"><i class="fas fa-th-large"></i></button>
                                <button type="button" class="btn btn-outline-primary" title="عرض قائمة" onclick="showAlert('info', 'عرض القائمة قيد التطوير')"><i class="fas fa-list"></i></button>
                            </div>
                            <button class="btn btn-secondary ms-2" onclick="refreshProducts()">
                                <i class="fas fa-refresh me-2"></i>
                                تحديث
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="search-box mb-4" style="background: white; border-radius: 10px; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="searchInput" 
                                           placeholder="البحث عن منتج..." onkeyup="filterProducts()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="categoryFilter" onchange="filterProducts()">
                                    <option value="">جميع الأصناف</option>
                                    <option value="all">الكل</option>
                                    <!-- Categories will be loaded here dynamically -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter" onchange="filterProducts()">
                                    <option value="">جميع الحالات</option>
                                    <option value="active">نشط</option>
                                    <option value="inactive">غير نشط</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="addNewProduct()">
                                    <i class="fas fa-plus me-1"></i>
                                    إضافة منتج
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Products Grid -->
                    <div class="product-grid" id="productsGrid">
                        <div class="col-12 text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <p class="mt-2">جاري تحميل المنتجات...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Page -->
                <div id="cart" class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>
                            سلة التسوق
                        </h2>
                        <div>
                            <button class="btn btn-warning" onclick="clearCart()">
                                <i class="fas fa-trash me-2"></i>
                                تفريغ السلة
                            </button>
                            <button class="btn btn-secondary" onclick="refreshCart()">
                                <i class="fas fa-refresh me-2"></i>
                                تحديث
                            </button>
                        </div>
                    </div>
                    
                    <div class="cart-container">
                        <!-- Products Section -->
                        <div class="products-section">
                            <!-- Search and Filter -->
                            <div class="category-filter mb-3">
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input type="text" class="form-control" id="cartSearchInput" 
                                                   placeholder="البحث عن منتج في السلة..." onkeyup="filterCartProducts()">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <select class="form-select" id="cartCategoryFilter" onchange="filterCartProducts()">
                                            <option value="">جميع الأصناف</option>
                                            <option value="all">الكل</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Products Grid -->
                            <div class="product-grid" id="cartProductsGrid">
                                <div class="col-12 text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">جاري التحميل...</span>
                                    </div>
                                    <p class="mt-2">جاري تحميل المنتجات...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Cart Section -->
                        <div class="cart-section">
                            <div class="cart-card">
                                <h5 class="mb-3">
                                    <i class="fas fa-shopping-cart me-2"></i>
                                    السلة
                                </h5>
                                
                                <div id="cartItems">
                                    <div class="empty-cart">
                                        <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                                        <p>السلة فارغة</p>
                                    </div>
                                </div>
                                
                                <div class="total-section" id="totalSection" style="display: none;">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>الإجمالي:</span>
                                        <strong class="text-success" id="total">0 دج</strong>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button class="checkout-btn" onclick="checkout()">
                                            <i class="fas fa-check-circle me-2"></i>
                                            إتمام الطلب
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Orders Page -->
                <div id="orders" class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0"><i class="fas fa-shopping-bag me-2"></i>إدارة الطلبات</h2>
                        <div>
                            <button class="btn btn-primary" onclick="refreshOrders()">
                                <i class="fas fa-refresh me-2"></i>
                                تحديث
                            </button>
                            <button class="btn btn-success" onclick="addNewOrder()">
                                <i class="fas fa-plus me-2"></i>
                                طلب جديد
                            </button>
                        </div>
                    </div>
                    
                    <!-- Orders Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: rgba(255,255,255,0.9);">إجمالي الطلبات</h6>
                                        <div class="stat-number" id="orders-totalOrders">0</div>
                                    </div>
                                    <div style="font-size: 2rem; color: rgba(255,255,255,0.7);"><i class="fas fa-shopping-bag"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: rgba(255,255,255,0.9);">طلبات معلقة</h6>
                                        <div class="stat-number" id="orders-pendingOrders">0</div>
                                    </div>
                                    <div style="font-size: 2rem; color: rgba(255,255,255,0.7);"><i class="fas fa-clock"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #00b09b, #96c93d); color: white; border: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: rgba(255,255,255,0.9);">طلبات مكتملة</h6>
                                        <div class="stat-number" id="orders-completedOrders">0</div>
                                    </div>
                                    <div style="font-size: 2rem; color: rgba(255,255,255,0.7);"><i class="fas fa-check-circle"></i></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; border: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-2" style="color: rgba(255,255,255,0.9);">إجمالي الإيرادات</h6>
                                        <div class="stat-number" id="orders-totalRevenue">0 دج</div>
                                    </div>
                                    <div style="font-size: 2rem; color: rgba(255,255,255,0.7);"><i class="fas fa-money-bill-wave"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filter and Search -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i class="fas fa-filter text-primary"></i></span>
                                        <select class="form-select border-0" id="orderStatusFilter" onchange="filterOrders()">
                                            <option value="">جميع الحالات</option>
                                            <option value="pending">معلق</option>
                                            <option value="processing">قيد المعالجة</option>
                                            <option value="shipped">تم الشحن</option>
                                            <option value="delivered">تم التسليم</option>
                                            <option value="cancelled">ملغي</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-0"><i class="fas fa-search text-primary"></i></span>
                                        <input type="text" class="form-control border-0" id="orderSearch" placeholder="البحث عن طلب (رقم الطلب، اسم العميل، الهاتف)" onkeyup="searchOrders()">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Orders Container - Split Layout -->
                    <div class="row">
                        <!-- Orders List - Right Side -->
                        <div class="col-md-6">
                            <div class="card" style="box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                                <div class="card-header text-white" style="background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));">
                                    <h5 class="mb-0">
                                        <i class="fas fa-list me-2"></i>
                                        قائمة الطلبات
                                    </h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="orders-list" style="max-height: 600px; overflow-y: auto;">
                                        <table class="table table-striped table-hover mb-0">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th>رقم الطلب</th>
                                                    <th>العميل</th>
                                                    <th>الإجمالي</th>
                                                    <th>الحالة</th>
                                                    <th>الإجراءات</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ordersTableBody">
                                                <tr>
                                                    <td colspan="5" class="text-center">
                                                        <div class="spinner-border" role="status">
                                                            <span class="visually-hidden">جاري التحميل...</span>
                                                        </div>
                                                        <p class="mt-2">جاري تحميل الطلبات...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Details - Left Side -->
                        <div class="col-md-6">
                            <div class="card" style="min-height: 668px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
                                <div class="card-header text-white" style="background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));">
                                    <h5 class="mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        تفاصيل الطلب
                                    </h5>
                                </div>
                                <div class="card-body d-flex align-items-center justify-content-center" id="orderDetailsContainer">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-hand-pointer fa-4x mb-4 text-primary opacity-50"></i>
                                        <h5 class="mb-2">لم يتم تحديد أي طلب</h5>
                                        <p>الرجاء اختيار طلب من القائمة على اليمين لعرض تفاصيله هنا.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Categories Page -->
                <div id="categories" class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-tags"></i> إدارة الأصناف</h2>
                        <div>
                            <button class="btn btn-primary" onclick="refreshCategories()">
                                <i class="fas fa-refresh me-2"></i>
                                تحديث
                            </button>
                            <button class="btn btn-success" onclick="showAddCategoryModal()">
                                <i class="fas fa-plus me-2"></i>
                                صنف جديد
                            </button>
                            <div class="btn-group ms-2" role="group">
                                <button class="btn btn-outline-info btn-sm" onclick="showCacheStats()" title="إحصائيات الكاش">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="clearCache()" title="مسح الكاش">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Categories Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="stat-card info">
                                <h6><i class="fas fa-tags me-2"></i>إجمالي الأصناف</h6>
                                <div class="stat-number" id="totalCategories">0</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stat-card success">
                                <h6><i class="fas fa-box me-2"></i>منتجات بالأصناف</h6>
                                <div class="stat-number" id="productsInCategories">0</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stat-card warning">
                                <h6><i class="fas fa-chart-line me-2"></i>متوسط المنتجات</h6>
                                <div class="stat-number" id="avgProductsPerCategory">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="categorySearch" placeholder="البحث عن صنف (الاسم، المعرف)" onkeyup="searchCategories()">
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="categorySort" onchange="sortCategories()">
                                <option value="name">ترتيب حسب الاسم</option>
                                <option value="id">ترتيب حسب المعرف</option>
                                <option value="products">ترتيب حسب عدد المنتجات</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="categoryLoadingState" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                        <p class="mt-2">جاري تحميل الأصناف...</p>
                        <div class="progress mt-3" style="max-width: 300px; margin: 0 auto;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div id="categoryErrorState" class="alert alert-danger" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-3"></i>
                            <div>
                                <h5>خطأ في التحميل</h5>
                                <p class="mb-2" id="categoryErrorMessage">فشل في تحميل الأصناف</p>
                                <button class="btn btn-light btn-sm" onclick="loadCategories()">
                                    <i class="fas fa-redo"></i> إعادة المحاولة
                                </button>
                                <button class="btn btn-outline-light btn-sm ms-2" onclick="window.open('category_debug.html', '_blank')">
                                    <i class="fas fa-bug"></i> تشخيص المشكلة
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Categories Grid -->
                    <div class="row" id="categoriesGrid">
                        <!-- Categories will be loaded here dynamically -->
                    </div>
                </div>
                
                <div id="reports" class="page-content">
                    <h2>التقارير</h2>
                    <p>صفحة التقارير قيد التطوير...</p>
                </div>
                
                <div id="settings" class="page-content">
                    <h2><i class="fas fa-cog me-2"></i>الإعدادات</h2>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6><i class="fas fa-sync me-2"></i>المزامنة</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="autoSync" checked>
                                        <label class="form-check-label" for="autoSync">مزامنة تلقائية</label>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small">Google Sheets URL</label>
                                        <input type="url" class="form-control form-control-sm" id="sheetsUrl" placeholder="رابط الجدول">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6><i class="fas fa-palette me-2"></i>الواجهة</h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="darkMode">
                                        <label class="form-check-label" for="darkMode">وضع ليلي</label>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small">اللغة</label>
                                        <select class="form-select form-select-sm" id="language">
                                            <option value="ar" selected>العربية</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <button type="button" class="btn btn-primary btn-sm me-2" onclick="saveSettings()">
                                <i class="fas fa-save me-1"></i>حفظ
                            </button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="resetSettings()">
                                <i class="fas fa-undo me-1"></i>إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة صنف جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCategoryForm">
                        <div class="mb-3">
                            <label for="categoryId" class="form-label">معرف الصنف</label>
                            <input type="text" class="form-control" id="categoryId" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">اسم الصنف</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label for="imageUrl" class="form-label">رابط الصورة</label>
                            <input type="url" class="form-control" id="imageUrl" 
                                   placeholder="https://example.com/image.jpg">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="addCategory()">
                        <i class="fas fa-save"></i> حفظ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Google Sheets Integration -->
    <script src="google_sheets_integration.js"></script>
    <!-- Intelligent Caching System -->
    <script src="intelligent_cache.js"></script>
    
    <script>
        // Format date as DD/MM/YYYY HH:mm:ss
        function formatDateTime(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        // Format quantity as "count×(pieces per pack)ق"
        function formatQuantity(quantity, quantityPerPack = 1) {
            if (quantityPerPack > 1) {
                return `${quantity} × (${quantityPerPack} قطعة)`;
            }
            return `${quantity} قطعة`;
        }

        // Global variables
        let cart = [];
        let products = [];
        let orders = [];
        let currentCategory = 'all';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Page loaded, initializing...');
            
            // Auto-save Google Sheets settings
            localStorage.setItem('googleSheetsSettings', JSON.stringify({
                webAppUrl: 'https://script.google.com/macros/s/AKfycbxQmwApMVQ2ZYPIHj63AA-Z1p1wQihyCFe0ypJNMheJl7UN0acV7wZZwBSOrDptyBp8ig/exec',
                spreadsheetId: '1PmqiCI3FXiP0rswBXda-ReJySE4VkHcmIh3rvzfAh5k'
            }));
            
            // Check internet connection first
            if (!navigator.onLine) {
                showAlert('warning', 'لا يوجد اتصال بالإنترنت. سيتم استخدام البيانات المحلية.');
                // Continue with local data
                await loadDashboardData();
                await loadProducts();
                initChart();
                return;
            }
            
            // Wait a bit for everything to load
            setTimeout(async () => {
                try {
                    console.log('Starting initialization...');
                    
                    // Check Google Sheets availability
                    console.log('Forcing Google Sheets check...');
                    await window.dataSyncManager.checkGoogleSheetsAvailability();
                    
                    // Force enable Google Sheets if configured
                    if (window.dataSyncManager.sheetsAPI.isConfigured()) {
                        console.log('Google Sheets is configured, forcing usage...');
                        window.dataSyncManager.isUsingGoogleSheets = true;
                    }
                    
                    console.log('Google Sheets availability:', window.dataSyncManager.isUsingGoogleSheets);
                    
                    // Start auto-sync if Google Sheets is available
                    if (window.dataSyncManager.isUsingGoogleSheets) {
                        console.log('Starting auto-sync with Google Sheets...');
                        window.dataSyncManager.startAutoSync(5);
                        console.log('Auto-sync started with 5-minute interval');
                        
                        // Load initial data
                        await loadDashboardData();
                        await loadProducts();
                        showAlert('success', 'تم الاتصال بـ Google Sheets بنجاح! المزامنة التلقائية مفعلة.');
                    } else {
                        console.log('Using mock data - no auto-sync');
                        
                        // Load mock data
                        await loadDashboardData();
                        await loadProducts();
                        showAlert('info', 'استخدام البيانات الوهمية - يرجى إعداد Google Sheets');
                    }
                    
                    // Load categories into filter
                    if (window.categories) {
                        const categoryFilter = document.getElementById('categoryFilter');
                        if (categoryFilter) {
                            // Clear existing options except "all" and "جميع الأصناف"
                            while (categoryFilter.options.length > 2) {
                                categoryFilter.remove(categoryFilter.options.length - 1);
                            }
                            
                            // Add "all" option
                            const allOption = document.createElement('option');
                            allOption.value = 'all';
                            allOption.textContent = 'الكل';
                            categoryFilter.add(allOption);
                            
                            // Add categories dynamically
                            window.categories.forEach(category => {
                                const option = document.createElement('option');
                                option.value = category.category_id;
                                option.textContent = category.category_name;
                                categoryFilter.add(option);
                            });
                        }
                    }
                    
                    // Update sync status display
        function updateSyncStatus(isActive, message = '') {
            const syncStatusDiv = document.getElementById('syncStatus');
            if (syncStatusDiv) {
                if (isActive) {
                    syncStatusDiv.innerHTML = `
                        <div class="spinner-border spinner-border-sm text-success mb-2" role="status">
                            <span class="visually-hidden">Syncing...</span>
                        </div>
                        <p class="text-success">المزامنة نشطة</p>
                        <small class="text-muted">${message}</small>
                    `;
                } else {
                    syncStatusDiv.innerHTML = `
                        <div class="spinner-border spinner-border-sm text-warning mb-2" role="status">
                            <span class="visually-hidden">Checking...</span>
                        </div>
                        <p class="text-warning">جاري التحقق...</p>
                        <small class="text-muted">${message}</small>
                    `;
                }
            }
        }
                    console.log('Initializing notification system...');
                    initializeNotificationSystem();
                    
                    initChart();
                    console.log('Initialization completed successfully!');
                    
                    // Show sync status
                    if (window.dataSyncManager.isUsingGoogleSheets) {
                        updateSyncStatus(true, 'كل 5 دقائق');
                        showAlert('info', 'المزامنة التلقائية مفعلة كل 5 دقائق');
                        console.log('Auto-sync enabled with 5-minute interval');
                    } else {
                        updateSyncStatus(false, 'جاري التحقق من الاتصال...');
                        showAlert('warning', 'Google Sheets غير متاح، يرجى التحقق من الإعدادات');
                        console.log('Google Sheets not available, checking connection...');
                    }
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    showAlert('danger', 'حدث خطأ أثناء التحميل. جاري استخدام البيانات المحلية...');
                    
                    // Fallback to local data
                    try {
                        await loadDashboardData();
                        await loadProducts();
                        initChart();
                        showAlert('info', 'تم التحميل باستخدام البيانات المحلية');
                    } catch (fallbackError) {
                        console.error('Fallback error:', fallbackError);
                        showAlert('danger', 'فشل التحميل الكامل. يرجى تحديث الصفحة.');
                    }
                }
            }, 1000);
        });
        
        // Utility functions
        function formatCurrency(amount) {
            return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Find and activate the correct nav link
            const activeLink = document.querySelector(`.nav-link[onclick*="${pageId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Clear new orders badge when viewing orders page
            if (pageId === 'orders') {
                clearNewOrdersBadge();
            }
            
            // Load page-specific data
            if (pageId === 'dashboard') {
                loadDashboardData();
            } else if (pageId === 'products') {
                loadProducts();
            } else if (pageId === 'cart') {
                loadCartProducts();
            } else if (pageId === 'orders') {
                loadOrders();
            } else if (pageId === 'categories') {
                loadCategories();
            }
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                
                // Use Google Sheets if available, otherwise use mock API
                if (window.dataSyncManager && window.dataSyncManager.isUsingGoogleSheets) {
                    // Load from Google Sheets
                    const products = await window.dataSyncManager.sheetsAPI.getSheetData('products');
                    const orders = await window.dataSyncManager.sheetsAPI.getSheetData('orders');
                    const customers = await window.dataSyncManager.sheetsAPI.getSheetData('customers');
                    
                    console.log('Loaded data from Google Sheets:', {
                        products: products.length,
                        orders: orders.length,
                        customers: customers.length
                    });
                    
                    // Update statistics
                    document.getElementById('totalProducts').textContent = products.length;
                    document.getElementById('totalOrders').textContent = orders.length;
                    document.getElementById('pendingOrders').textContent = orders.filter(order => order[3] === 'pending').length;
                    
                    const totalRevenue = orders.reduce((sum, order) => {
                        const price = parseFloat(order[2]) || 0;
                        return sum + price;
                    }, 0);
                    document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue) + ' دج';
                    
                    // Update recent orders
                    const recentOrdersHtml = orders.slice(0, 5).map(order => {
                        const customer = customers.find(c => c[0] === order[1]);
                        const customerName = customer ? customer[1] : 'عميل غير معروف';
                        
                        return `
                            <div class="order-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${order[0]}</strong>
                                        <div class="text-muted small">${customerName}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="status-badge status-${order[3]}">${getOrderStatusText(order[3])}</div>
                                        <div class="text-primary fw-bold">${parseFloat(order[2]).toFixed(2)} دج</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('recentOrders').innerHTML = recentOrdersHtml || '<p class="text-muted">لا توجد طلبات حديثة</p>';
                    
                } else {
                    // Fallback to mock API
                    console.log('Using mock API for dashboard data...');
                    const response = await fetch('/admin/api/stats');
                    const stats = await response.json();
                    
                    document.getElementById('totalProducts').textContent = stats.totalProducts;
                    document.getElementById('totalOrders').textContent = stats.totalOrders;
                    document.getElementById('pendingOrders').textContent = stats.pendingOrders;
                    document.getElementById('totalRevenue').textContent = formatCurrency(stats.totalRevenue) + ' دج';
                    
                    // Load recent orders
                    const recentOrdersHtml = stats.recentOrders.map(order => `
                        <div class="order-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${order.order_id}</strong>
                                    <div class="text-muted small">${order.customer_name}</div>
                                </div>
                                <div class="text-end">
                                    <div class="status-badge status-${order.order_status}">${getOrderStatusText(order.order_status)}</div>
                                    <div class="text-primary fw-bold">${formatCurrency(order.total_price)} دج</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('recentOrders').innerHTML = recentOrdersHtml;
                }
                
                console.log('Dashboard data loaded successfully');
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showAlert('danger', 'حدث خطأ أثناء تحميل البيانات');
                
                // Fallback to empty state
                document.getElementById('totalProducts').textContent = '0';
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('pendingOrders').textContent = '0';
                document.getElementById('totalRevenue').textContent = '0 دج';
                document.getElementById('recentOrders').innerHTML = '<p class="text-muted">لا توجد بيانات متاحة</p>';
            }
        }
        
        // Load products
        async function loadProducts() {
            try {
                console.log('🔄 Loading products with intelligent cache...');
                
                // Use intelligent cache if available
                if (window.intelligentCache) {
                    const result = await window.intelligentCache.get('products');
                    
                    if (result.success) {
                        products = result.data;
                        displayProducts();
                        
                        // Load categories into filter if not already loaded
                        if (!window.categories || window.categories.length === 0) {
                            await loadCategories();
                        } else {
                            loadCategoriesIntoFilter();
                        }
                        
                        if (result.fromCache) {
                            const ageText = result.stale ? 'قديمة' : `${Math.round(result.age / 1000)} ثانية`;
                            showNotification(`تم تحميل المنتجات من الكاش (${ageText})`, 'info');
                        } else {
                            showNotification('تم تحميل المنتجات من Google Sheets', 'success');
                        }
                        return;
                    } else {
                        showNotification('فشل في تحميل المنتجات: ' + result.error, 'danger');
                    }
                }
                
                // Fallback to original method if intelligent cache not available
                console.log('🔄 Using fallback loading method for products...');
                
                // Use Google Sheets if available, otherwise use mock API
                if (window.dataSyncManager && window.dataSyncManager.isUsingGoogleSheets) {
                    // Load from Google Sheets
                    const [productsData, categoriesData] = await Promise.all([
                        window.dataSyncManager.sheetsAPI.getSheetData('products'),
                        window.dataSyncManager.sheetsAPI.getSheetData('category')
                    ]);
                    
                    // Convert to product objects matching Google Sheets columns
                    products = productsData.map((row, index) => ({
                        id: index + 1,
                        product_id: row[0] || '',        // product_id column
                        category_id: row[1] || '',        // category_id column  
                        product_name: row[2] || '',      // product_name column
                        qtepack: parseInt(row[3]) || 1,  // qtepack column
                        price: parseFloat(row[4]) || 0,   // price column
                        image_url: row[5] || '',         // image_url column
                        status: row[6] || 'disponible', // status column
                        description: row[7] || ''        // description column
                    }));
                    
                    // Store categories globally
                    window.categories = categoriesData.map((row, index) => ({
                        id: index + 1,
                        category_id: row[0] || '',
                        category_name: row[1] || '',
                        image_url: row[2] || '',
                        product_count: 0
                    }));
                    
                    displayProducts();
                    
                    // Load categories into filter
                    loadCategoriesIntoFilter();
                    loadCategoriesIntoCartFilter();
                } else {
                    // Fallback to mock API
                    const [productsResponse, categoriesResponse] = await Promise.all([
                        fetch('/admin/api/products'),
                        fetch('/admin/api/category')
                    ]);
                    
                    products = await productsResponse.json();
                    window.categories = await categoriesResponse.json();
                    displayProducts();
                    
                    // Load categories into filter
                    loadCategoriesIntoFilter();
                    loadCategoriesIntoCartFilter();
                }
            } catch (error) {
                console.error('Error loading products:', error);
                showNotification('فشل في تحميل المنتجات', 'danger');
                
                // Fallback to mock data
                products = [
                    { id: 1, product_id: 'prod-0001', category_id: 'ctg-002', product_name: 'بينغو 1 ليتر غسالة', qtepack: 9, price: 314.00, image_url: 'https://res.cloudinary.com/dgtnnmpgz/image/upload/v1769111352/image_21_rtzqii.jpg', status: 'disponible', description: '' },
                    { id: 2, product_id: 'prod-0002', category_id: 'ctg-002', product_name: 'بينغو 1.2ل', qtepack: 12, price: 264.00, image_url: 'https://res.cloudinary.com/dgtnnmpgz/image/upload/v1769111343/image_18_wcwphb.png', status: 'disponible', description: '' }
                ];
                displayProducts();
            }
        }
        
        // Load categories into filter dropdown
        function loadCategoriesIntoFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter && window.categories) {
                // Clear existing options except first two
                while (categoryFilter.options.length > 2) {
                    categoryFilter.remove(categoryFilter.options.length - 1);
                }
                
                // Add real categories dynamically
                window.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.category_id;
                    option.textContent = `${category.category_name} (${category.product_count || 0} منتج)`;
                    categoryFilter.add(option);
                });
                
                console.log(`📦 Loaded ${window.categories.length} categories into filter dropdown`);
            }
        }
        
        function generateProductCardHTML(product) {
            const category = window.categories && window.categories.find(cat => cat.category_id === product.category_id);
            const categoryName = category ? category.category_name : 'غير مصنف';

            // Add stopPropagation to all button clicks to prevent the parent's onclick from firing
            return `
                <div class="product-card-v2">
                    <div class="product-card-v2-image-wrapper" onclick="showProductModal(${product.id})">
                        <span class="product-status-badge status-badge status-${product.status}">${getProductStatusText(product.status)}</span>
                        <img src="${product.image_url}" class="product-card-v2-image" alt="${product.product_name}"
                             onerror="this.src='https://via.placeholder.com/200x120?text=No+Image'">
                        <div class="product-card-v2-actions">
                            <button class="btn btn-sm btn-light btn-icon" onclick="event.stopPropagation(); showProductModal(${product.id})" title="عرض التفاصيل"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-light btn-icon" onclick="event.stopPropagation(); editProduct(${product.id})" title="تعديل"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-light btn-icon" onclick="event.stopPropagation(); deleteProduct(${product.id})" title="حذف"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="product-card-v2-body">
                        <div class="product-category text-muted small">${categoryName}</div>
                        <h6 class="product-title" title="${product.product_name}">${product.product_name}</h6>
                        <div class="product-meta">
                            <span class="text-primary">${formatCurrency(product.price)} دج</span>
                            <span title="القطع في العبوة"><i class="fas fa-box-open me-1"></i> ${product.qtepack || 1}</span>
                        </div>
                    </div>
                    <div class="product-card-v2-footer">
                        <button class="btn btn-success btn-sm w-100" onclick="event.stopPropagation(); addToCart(${product.id})">
                            <i class="fas fa-cart-plus me-1"></i> إضافة للسلة
                        </button>
                    </div>
                </div>
            `;
        }

        // Display products
        function displayProducts() {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;
            
            if (products.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center py-5" style="grid-column: 1 / -1;"><i class="fas fa-box-open fa-3x text-muted mb-3"></i><p>لا توجد منتجات لعرضها.</p></div>';
                return;
            }
            
            grid.innerHTML = products.map(product => generateProductCardHTML(product)).join('');
        }
        
        // Load cart products
        async function loadCartProducts() {
            try {
                // Use Google Sheets if available, otherwise use mock API
                if (window.dataSyncManager && window.dataSyncManager.isUsingGoogleSheets) {
                    // Load from Google Sheets
                    const [productsData, categoriesData] = await Promise.all([
                        window.dataSyncManager.sheetsAPI.getSheetData('products'),
                        window.dataSyncManager.sheetsAPI.getSheetData('category')
                    ]);
                    
                    // Convert to product objects
                    products = productsData.map((row, index) => ({
                        id: index + 1,
                        product_id: row[0] || '',
                        category_id: row[1] || '',
                        product_name: row[2] || '',
                        quantity_per_pack: parseInt(row[3]) || 1,
                        qtepack: parseInt(row[3]) || 1,
                        price: parseFloat(row[4]) || 0,
                        image_url: row[5] || '',
                        status: row[6] || 'active',
                        description: row[7] || ''
                    }));
                    
                    // Store categories globally
                    window.categories = categoriesData.map((row, index) => ({
                        id: index + 1,
                        category_id: row[0] || '',
                        category_name: row[1] || '',
                        image_url: row[2] || '',
                        description: row[3] || '',
                        product_count: 0
                    }));
                    
                    displayCartProducts();
                    
                    // Load categories into cart filter
                    loadCategoriesIntoCartFilter();
                } else {
                    // Fallback to mock API
                    const [productsResponse, categoriesResponse] = await Promise.all([
                        fetch('/admin/api/products'),
                        fetch('/admin/api/category')
                    ]);
                    
                    products = await productsResponse.json();
                    products = products.map(p => ({
                        ...p,
                        qtepack: p.qtepack || p.quantity_per_pack || 1,
                        quantity_per_pack: p.quantity_per_pack || p.qtepack || 1
                    }));
                    window.categories = await categoriesResponse.json();
                    displayCartProducts();
                    
                    // Load categories into cart filter
                    loadCategoriesIntoCartFilter();
                }
            } catch (error) {
                console.error('Error loading cart products:', error);
                showAlert('danger', 'حدث خطأ أثناء تحميل المنتجات');
            }
        }
        
        // Load categories into cart filter dropdown
        function loadCategoriesIntoCartFilter() {
            const categoryFilter = document.getElementById('cartCategoryFilter');
            if (categoryFilter && window.categories) {
                // Clear existing options except first two
                while (categoryFilter.options.length > 2) {
                    categoryFilter.remove(categoryFilter.options.length - 1);
                }
                
                // Add real categories dynamically
                window.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.category_id;
                    option.textContent = `${category.category_name} (${category.product_count || 0} منتج)`;
                    categoryFilter.add(option);
                });
                
                console.log(`🛒 Loaded ${window.categories.length} categories into cart filter dropdown`);
            }
        }
        
        // Display cart products
        function displayCartProducts() {
            const grid = document.getElementById('cartProductsGrid');
            if (!grid) return;
            
            const filteredProducts = currentCategory === 'all' 
                ? products 
                : products.filter(p => p.category_id === currentCategory);
            
            if (filteredProducts.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center py-5" style="grid-column: 1 / -1;"><i class="fas fa-box-open fa-3x text-muted mb-3"></i><p>لا توجد منتجات لعرضها.</p></div>';
                return;
            }
            
            grid.innerHTML = filteredProducts.map(product => generateProductCardHTML(product)).join('');
        }
        
        // Filter cart products
        function filterCartProducts() {
            const searchTerm = document.getElementById('cartSearchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('cartCategoryFilter').value;
            
            const grid = document.getElementById('cartProductsGrid');
            if (!grid) return;
            
            let filteredProducts = products;
            
            // Apply search filter
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product => 
                    product.product_name.toLowerCase().includes(searchTerm) ||
                    (product.description && product.description.toLowerCase().includes(searchTerm)) ||
                    (product.product_id && product.product_id.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply category filter
            if (categoryFilter && categoryFilter !== 'all' && categoryFilter !== '') {
                filteredProducts = filteredProducts.filter(product => 
                    product.category_id === categoryFilter
                );
            }
            
            // Display filtered products
            if (filteredProducts.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center py-5" style="grid-column: 1 / -1;"><i class="fas fa-search fa-3x text-muted mb-3"></i><p>لا توجد منتجات تطابق بحثك.</p></div>';
                return;
            }
            
            grid.innerHTML = filteredProducts.map(product => generateProductCardHTML(product)).join('');
        }
        
        // Filter by category
        function filterByCategory(category) {
            currentCategory = category;
            
            // Update active button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayCartProducts();
        }
        
        // Add to cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    ...product,
                    quantity: 1
                });
            }
            
            updateCartDisplay();
            showAlert('success', 'تم إضافة المنتج للسلة');
        }
        
        // Update cart display
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const totalSection = document.getElementById('totalSection');
            const cartCount = document.getElementById('cartCount');
            
            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                        <p>السلة فارغة</p>
                    </div>
                `;
                totalSection.style.display = 'none';
                cartCount.textContent = '0';
            } else {
                cartItems.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <div>
                            <strong class="text-primary">${item.product_name}</strong>
                            <br>
                            <small class="text-muted">${formatCurrency(item.price)} دج</small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="quantity-controls">
                                <button class="quantity-btn btn-sm btn-danger" onclick="updateQuantity(${item.id}, -1)">-</button>
                                <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="99" 
                               onchange="setQuantity(${item.id}, this.value)"
                               onclick="this.select()"
                               onfocus="this.select()">
                                <button class="quantity-btn btn-sm btn-success" onclick="updateQuantity(${item.id}, 1)">+</button>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
                totalSection.style.display = 'block';
                updateTotals();
                cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            }
        }
        
        // Update quantity
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            item.quantity += change;
            
            if (item.quantity <= 0) {
                cart = cart.filter(item => item.id !== productId);
            }
            
            updateCartDisplay();
        }
        
        // Remove from cart
        function removeFromCart(productId) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                if (confirm(`هل أنت متأكد من حذف "${item.product_name}" من السلة؟`)) {
                    cart = cart.filter(item => item.id !== productId);
                    updateCartDisplay();
                    showAlert('success', 'تم حذف المنتج من السلة');
                }
            }
        }
        
        // Set quantity directly
        function setQuantity(productId, newQuantity) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;
            
            const quantity = parseInt(newQuantity);
            if (quantity > 0 && quantity <= 99) {
                item.quantity = quantity;
                updateCartDisplay();
            }
        }
        
        // Update totals
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => {
                const product = products.find(p => p.id === item.id);
                const quantityPerPack = product ? (product.quantity_per_pack || 1) : 1;
                return sum + (item.price * item.quantity * quantityPerPack);
            }, 0);
            
            // Remove tax calculation
            const total = subtotal;
            
            // Update only the total element (subtotal and tax are removed from cart)
            const totalElement = document.getElementById('total');
            if (totalElement) {
                totalElement.textContent = formatCurrency(total) + ' دج';
            }
        }
        
        // Clear cart
        function clearCart() {
            if (confirm('هل أنت متأكد من تفريغ السلة؟')) {
                cart = [];
                updateCartDisplay();
                showAlert('info', 'تم تفريغ السلة');
            }
        }
        
        // Checkout
        function checkout() {
            if (cart.length === 0) {
                showAlert('warning', 'السلة فارغة');
                return;
            }
            
            // Show customer info modal
            showCustomerModal();
        }
        
        // Show customer info modal
        function showCustomerModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-user me-2"></i>
                                معلومات العميل
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">اسم العميل:</label>
                                <input type="text" class="form-control" id="modalCustomerName" 
                                       placeholder="أدخل اسم العميل">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">رقم الهاتف:</label>
                                <input type="tel" class="form-control" id="modalCustomerPhone" 
                                       placeholder="أدخل رقم الهاتف">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">العنوان:</label>
                                <textarea class="form-control" id="modalCustomerAddress" 
                                          placeholder="أدخل العنوان" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">إلغاء</button>
                            <button type="button" class="btn btn-success" onclick="sendWhatsAppFromCheckout()">
                                <i class="fab fa-whatsapp me-2"></i>
                                إرسال إلى WhatsApp
                            </button>
                            <button type="button" class="btn btn-primary" onclick="processOrder()">
                                <i class="fas fa-check me-2"></i>
                                تأكيد الطلب
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Show modal
            setTimeout(() => {
                modal.classList.add('show');
                modal.style.display = 'block';
            }, 100);
            
            // Handle close button
            modal.querySelector('.btn-close').addEventListener('click', () => {
                modal.remove();
            });
            
            // Handle cancel button
            const cancelBtns = modal.querySelectorAll('[onclick*="remove"]');
            cancelBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.modal').remove();
                });
            });
            
            // Handle backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Process order with customer info
        function processOrder() {
            const customerName = document.getElementById('modalCustomerName').value;
            const customerPhone = document.getElementById('modalCustomerPhone').value;
            const customerAddress = document.getElementById('modalCustomerAddress').value;
            
            if (!customerName || !customerPhone || !customerAddress) {
                showAlert('warning', 'يرجى ملء جميع بيانات العميل');
                return;
            }
            
            // Close modal
            document.querySelector('.modal').remove();
            
            // Generate unique IDs
            const orderId = 'ORD' + Date.now();
            const customerId = 'CUST' + Date.now();
            
            const orderData = {
                order_id: orderId,
                customer_id: customerId,
                total_price: cart.reduce((sum, item) => {
                    const product = products.find(p => p.id === item.id);
                    const quantityPerPack = product ? (product.quantity_per_pack || 1) : 1;
                    return sum + (item.price * item.quantity * quantityPerPack);
                }, 0),
                order_status: 'pending',
                order_date: formatDateTime(new Date())
            };
            
            // Create order items
            const orderItems = cart.map((item, index) => {
                const product = products.find(p => p.id === item.id);
                const quantityPerPack = product ? (product.quantity_per_pack || 1) : 1;
                return {
                    item_id: 'ITEM' + Date.now() + '_' + index,
                    order_id: orderId,
                    product_id: item.product_id,
                    quantity: item.quantity,
                    unit_price: item.price,
                    subtotal: item.price * item.quantity * quantityPerPack
                };
            });
            
            // Create customer data
            const customerData = {
                customer_id: customerId,
                name: customerName,
                phone: customerPhone,
                address: customerAddress,
                email: '',
                created_date: new Date().toISOString().split('T')[0],
                is_active: 'true'
            };
            
            // Send order to Google Sheets if available
            if (window.dataSyncManager && window.dataSyncManager.isUsingGoogleSheets) {
                window.dataSyncManager.addOrderWithItems(orderData, orderItems)
                    .then(() => {
                        return window.dataSyncManager.sheetsAPI.addSheetData('customers', customerData);
                    })
                    .then(() => {
                        showAlert('success', 'تم إنشاء الطلب بنجاح');
                        cart = [];
                        updateCartDisplay();
                    })
                    .catch(error => {
                        console.error('Error creating order:', error);
                        showAlert('danger', 'فشل إنشاء الطلب');
                    });
            } else {
                // Fallback to mock API
                fetch('/admin/orders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customerName,
                        customerPhone,
                        customerAddress,
                        items: cart.map(item => ({
                            productId: item.id,
                            productName: item.product_name,
                            quantity: item.quantity,
                            price: item.price,
                            subtotal: item.price * item.quantity
                        })),
                        totalAmount: cart.reduce((sum, item) => {
                            const product = products.find(p => p.id === item.id);
                            const quantityPerPack = product ? (product.quantity_per_pack || 1) : 1;
                            return sum + (item.price * item.quantity * quantityPerPack);
                        }, 0)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showAlert('success', 'تم إنشاء الطلب بنجاح');
                    cart = [];
                    updateCartDisplay();
                })
                .catch(error => {
                    console.error('Error creating order:', error);
                    showAlert('danger', 'فشل إنشاء الطلب');
                });
            }
        }
        
        // Send WhatsApp from checkout
        function sendWhatsAppFromCheckout() {
            const customerName = document.getElementById('modalCustomerName').value;
            const customerPhone = document.getElementById('modalCustomerPhone').value;
            const customerAddress = document.getElementById('modalCustomerAddress').value;
            
            if (!customerName || !customerPhone || !customerAddress) {
                showAlert('warning', 'يرجى ملء جميع بيانات العميل');
                return;
            }
            
            // Close modal
            document.querySelector('.modal').remove();
            
            // Calculate total with quantity_per_pack
            const total = cart.reduce((sum, item) => {
                const product = products.find(p => p.id === item.id);
                const quantityPerPack = product ? (product.quantity_per_pack || 1) : 1;
                return sum + (item.price * item.quantity * quantityPerPack);
            }, 0);
            
            // Build WhatsApp message
            let message = `🛒 *طلب جديد*\n\n`;
            message += `👤 *العميل*: ${customerName}\n`;
            message += `📞 *الهاتف*: ${customerPhone}\n`;
            message += `📍 *العنوان*: ${customerAddress}\n\n`;
            message += `📦 *المنتجات*:\n`;
            
            cart.forEach((item, index) => {
                const product = products.find(p => p.id === item.id);
                const quantityPerPack = product ? (product.quantity_per_pack || 1) : 1;
                const itemTotal = item.price * item.quantity * quantityPerPack;
                
                message += `${index + 1}. ${item.product_name}\n`;
                message += `   الكمية: ${formatQuantity(item.quantity, quantityPerPack)}\n`;
                message += `   السعر: ${formatCurrency(item.price)} دج\n`;
                message += `   الإجمالي: ${formatCurrency(itemTotal)} دج\n\n`;
            });
            
            message += `💰 *الإجمالي*: ${formatCurrency(total)} دج\n`;
            message += `📅 *التاريخ*: ${formatDateTime(new Date())}\n`;
            
            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);
            
            // WhatsApp URL
            const whatsappUrl = `https://wa.me/${customerPhone.replace(/[^\d]/g, '')}?text=${encodedMessage}`;
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank');
            
            showAlert('success', 'تم فتح WhatsApp لإرسال الطلب');
        }
        
        // Show product modal
        function showProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const category = window.categories && window.categories.find(cat => cat.category_id === product.category_id);
            const categoryName = category ? category.category_name : `${product.quantity_per_pack || 1} قطع`;
            
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-box me-2"></i>
                                تفاصيل المنتج
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-3">
                                <img src="${product.image_url}" class="img-fluid rounded" style="max-height: 100px;" alt="${product.product_name}"
                                     onerror="this.src='https://via.placeholder.com/180x100?text=No+Image'">
                            </div>
                            <h5 class="text-center mb-2">${product.product_name}</h5>
                            <p class="text-muted text-center mb-2">
                                <i class="fas fa-tag me-1"></i>
                                ${categoryName}
                            </p>
                            <h4 class="text-primary text-center mb-3">${formatCurrency(product.price)} دج</h4>
                            
                            <div class="d-flex align-items-center justify-content-center mb-3">
                                <label class="me-3">الكمية:</label>
                                <div class="quantity-controls">
                                    <button class="quantity-btn" onclick="decreaseModalQuantity()">-</button>
                                    <input type="number" class="quantity-input" id="modalQuantity" value="1" min="1" max="99" onclick="this.select()" onfocus="this.select()">
                                    <button class="quantity-btn" onclick="increaseModalQuantity()">+</button>
                                </div>
                            </div>
                            
                            <div class="alert alert-info text-center mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <small>الإجمالي: ${formatCurrency(product.price * (product.quantity_per_pack || 1))} دج</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">إلغاء</button>
                            <button type="button" class="btn btn-primary" onclick="addToCartFromModal(${product.id})">
                                <i class="fas fa-cart-plus me-2"></i>
                                إضافة للسلة
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Show modal
            setTimeout(() => {
                modal.classList.add('show');
                modal.style.display = 'block';
            }, 100);
            
            // Handle close button
            modal.querySelector('.btn-close').addEventListener('click', () => {
                modal.remove();
            });
            
            // Handle cancel button
            const cancelBtns = modal.querySelectorAll('[onclick*="remove"]');
            cancelBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.modal').remove();
                });
            });
            
            // Handle backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Modal quantity controls
        function increaseModalQuantity() {
            const input = document.getElementById('modalQuantity');
            input.value = Math.min(parseInt(input.value) + 1, 99);
        }
        
        function decreaseModalQuantity() {
            const input = document.getElementById('modalQuantity');
            input.value = Math.max(parseInt(input.value) - 1, 1);
        }
        
        // Add to cart from modal
        function addToCartFromModal(productId) {
            const quantity = parseInt(document.getElementById('modalQuantity').value);
            
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const product = products.find(p => p.id === productId);
                cart.push({
                    id: productId,
                    product_id: product.product_id,
                    product_name: product.product_name,
                    price: product.price,
                    quantity: quantity
                });
            }
            
            updateCartDisplay();
            
            // Find and remove the modal
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
            
            showAlert('success', 'تم إضافة المنتج للسلة');
        }
        
        // Show WhatsApp modal
        function showWhatsAppModal() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fab fa-whatsapp me-2"></i>
                                إرسال إلى WhatsApp
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">اسم العميل:</label>
                                <input type="text" class="form-control" id="whatsappCustomerName" 
                                       placeholder="أدخل اسم العميل">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">رقم الهاتف:</label>
                                <input type="tel" class="form-control" id="whatsappCustomerPhone" 
                                       placeholder="أدخل رقم الهاتف">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">العنوان:</label>
                                <textarea class="form-control" id="whatsappCustomerAddress" 
                                          placeholder="أدخل العنوان" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">إلغاء</button>
                            <button type="button" class="btn btn-success" onclick="sendWhatsAppMessage()">
                                <i class="fab fa-whatsapp me-2"></i>
                                إرسال الرسالة
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Show modal
            setTimeout(() => {
                modal.classList.add('show');
                modal.style.display = 'block';
            }, 100);
            
            // Handle close button
            modal.querySelector('.btn-close').addEventListener('click', () => {
                modal.remove();
            });
            
            // Handle cancel button
            const cancelBtns = modal.querySelectorAll('[onclick*="remove"]');
            cancelBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.target.closest('.modal').remove();
                });
            });
            
            // Handle backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Send WhatsApp message
        function sendWhatsAppMessage() {
            const customerName = document.getElementById('whatsappCustomerName').value;
            const customerPhone = document.getElementById('whatsappCustomerPhone').value;
            const customerAddress = document.getElementById('whatsappCustomerAddress').value;
            
            if (!customerName || !customerPhone || !customerAddress) {
                showAlert('warning', 'يرجى ملء جميع بيانات العميل');
                return;
            }
            
            // Close modal
            document.querySelector('.modal').remove();
            
            // Calculate total with quantity_per_pack
            const total = cart.reduce((sum, item) => {
                const product = products.find(p => p.id === item.id);
                const quantityPerPack = product ? (product.quantity_per_pack || 1) : 1;
                return sum + (item.price * item.quantity * quantityPerPack);
            }, 0);
            
            // Build WhatsApp message
            let message = `🛒 *طلب جديد*\n\n`;
            message += `👤 *العميل*: ${customerName}\n`;
            message += `📞 *الهاتف*: ${customerPhone}\n`;
            message += `📍 *العنوان*: ${customerAddress}\n\n`;
            message += `📦 *المنتجات*:\n`;
            
            cart.forEach((item, index) => {
                const product = products.find(p => p.id === item.id);
                const quantityPerPack = product ? (product.quantity_per_pack || 1) : 1;
                const itemTotal = item.price * item.quantity * quantityPerPack;
                
                message += `${index + 1}. ${item.product_name}\n`;
                message += `   الكمية: ${formatQuantity(item.quantity, quantityPerPack)}\n`;
                message += `   السعر: ${formatCurrency(item.price)} دج\n`;
                message += `   الإجمالي: ${formatCurrency(itemTotal)} دج\n\n`;
            });
            
            message += `💰 *الإجمالي*: ${formatCurrency(total)} دج\n`;
            message += `📅 *التاريخ*: ${formatDateTime(new Date())}\n`;
            
            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);
            
            // WhatsApp URL
            const whatsappUrl = `https://wa.me/${customerPhone.replace(/[^\d]/g, '')}?text=${encodedMessage}`;
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank');
            
            showAlert('success', 'تم فتح WhatsApp لإرسال الطلب');
        }
        
        // Filter products
        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const filteredProducts = products.filter(product => {
                const matchesSearch = !searchTerm || product.product_name.toLowerCase().includes(searchTerm) ||
                                   (product.description && product.description.toLowerCase().includes(searchTerm));
                const matchesCategory = !categoryFilter || categoryFilter === 'all' || product.category_id === categoryFilter;
                const matchesStatus = !statusFilter || product.status === statusFilter;
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            const grid = document.getElementById('productsGrid');
            if (grid) {
                if (filteredProducts.length === 0) {
                    grid.innerHTML = '<div class="col-12 text-center py-5" style="grid-column: 1 / -1;"><i class="fas fa-search fa-3x text-muted mb-3"></i><p>لا توجد منتجات تطابق بحثك.</p></div>';
                } else {
                    grid.innerHTML = filteredProducts.map(product => generateProductCardHTML(product)).join('');
                }
            }
        }
        
        // Delete product
        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                if (window.dataSyncManager && window.dataSyncManager.isUsingGoogleSheets) {
                    // Delete from Google Sheets
                    const product = products.find(p => p.id === id);
                    if (product) {
                        window.dataSyncManager.sheetsAPI.deleteSheetData('products', {
                            product_id: product.product_id
                        }).then(() => {
                            showAlert('success', 'تم حذف المنتج بنجاح');
                            loadProducts();
                        }).catch(error => {
                            console.error('Error deleting product:', error);
                            showAlert('danger', 'فشل حذف المنتج');
                        });
                    }
                } else {
                    // Fallback to mock API
                    fetch('/admin/products/' + id, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            showAlert('success', 'تم حذف المنتج بنجاح');
                            loadProducts();
                        } else {
                            showAlert('danger', 'فشل حذف المنتج');
                        }
                    })
                    .catch(error => {
                        showAlert('danger', 'حدث خطأ أثناء حذف المنتج');
                    });
                }
            }
        }
        function initChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو'],
                    datasets: [{
                        label: 'المبيعات',
                        data: [12000, 19000, 15000, 25000, 22000, 30000],
                        borderColor: '#3498DB',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' دج';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Utility functions
        function getOrderStatusText(status) {
            const statusMap = {
                'pending': 'قيد الانتظار',
                'processing': 'قيد المعالجة',
                'shipped': 'تم الشحن',
                'delivered': 'تم التسليم',
                'cancelled': 'ملغي'
            };
            return statusMap[status] || status;
        }
        
        function getProductStatusText(status) {
            const statusMap = {
                'active': 'نشط',
                'inactive': 'غير نشط'
            };
            return statusMap[status] || status;
        }
        
        function syncGoogleSheets() {
            console.log('syncGoogleSheets called, checking availability...');
            
            // Force re-check of Google Sheets availability first
            window.dataSyncManager.checkGoogleSheetsAvailability().then(() => {
                console.log('After checkGoogleSheetsAvailability in sync:', window.dataSyncManager.isUsingGoogleSheets);
                
                // Use Google Sheets integration
                if (window.dataSyncManager && window.dataSyncManager.isUsingGoogleSheets) {
                    console.log('Using Google Sheets for sync...');
                    window.dataSyncManager.syncAllData().then(success => {
                        if (success) {
                            showAlert('success', 'تمت المزامنة بنجاح');
                            refreshData();
                        } else {
                            showAlert('danger', 'فشلت المزامنة');
                        }
                    }).catch(error => {
                        console.error('Sync error:', error);
                        showAlert('danger', 'حدث خطأ أثناء المزامنة: ' + error.message);
                    });
                } else {
                    console.log('Google Sheets not available, showing warning...');
                    showAlert('warning', 'Google Sheets غير متاح، يرجى التحقق من الإعدادات');
                }
            }).catch(error => {
                console.error('Error checking availability:', error);
                showAlert('danger', 'حدث خطأ أثناء التحقق من التوفر: ' + error.message);
            });
        }
        
        function refreshData() {
            loadDashboardData();
        }
        
        function toggleDataSource() {
            if (window.dataSyncManager) {
                window.dataSyncManager.isUsingGoogleSheets = !window.dataSyncManager.isUsingGoogleSheets;
                const source = window.dataSyncManager.isUsingGoogleSheets ? 'Google Sheets' : 'Mock Data';
                showAlert('info', `تم التبديل إلى: ${source}`);
                console.log('Switched to:', source);
                
                // Reload data with new source
                loadDashboardData();
                loadProducts();
                initChart();
            } else {
                showAlert('warning', 'مدير المزامنة غير متوفر');
            }
        }
        
        function refreshProducts() {
            loadProducts();
        }
        
        function refreshCart() {
            loadCartProducts();
        }
        
        function addNewProduct() {
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-plus me-2"></i>
                                إضافة منتج جديد
                            </h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addProductForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">اسم المنتج</label>
                                        <input type="text" class="form-control" id="productName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">الصنف</label>
                                        <select class="form-select" id="productCategory" required>
                                            <option value="">اختر الصنف</option>
                                            ${window.categories ? window.categories.map(cat => `<option value="${cat.category_id}">${cat.category_name}</option>`).join('') : ''}
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">عدد القطع في العبوة</label>
                                        <input type="number" class="form-control" id="quantityPerPack" min="1" value="1" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">السعر</label>
                                        <input type="number" class="form-control" id="productPrice" min="0" step="0.01" required>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">الحالة</label>
                                        <select class="form-select" id="productStatus" required>
                                            <option value="active">نشط</option>
                                            <option value="inactive">غير نشط</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">رابط الصورة</label>
                                    <input type="url" class="form-control" id="productImage" placeholder="https://example.com/image.jpg">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">الوصف</label>
                                    <textarea class="form-control" id="productDescription" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">إلغاء</button>
                            <button type="button" class="btn btn-primary" onclick="saveNewProduct()">
                                <i class="fas fa-save me-2"></i>
                                حفظ المنتج
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Show modal
            setTimeout(() => {
                modal.classList.add('show');
                modal.style.display = 'block';
            }, 100);
            
            // Handle backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function saveNewProduct() {
            const form = document.getElementById('addProductForm');
            if (!form.checkValidity()) {
                showAlert('warning', 'يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            const newProduct = {
                product_id: 'PRD' + Date.now(),
                category_id: document.getElementById('productCategory').value,
                product_name: document.getElementById('productName').value,
                quantity_per_pack: parseInt(document.getElementById('quantityPerPack').value),
                price: parseFloat(document.getElementById('productPrice').value),
                image_url: document.getElementById('productImage').value || 'https://via.placeholder.com/300x300?text=No+Image',
                status: document.getElementById('productStatus').value,
                description: document.getElementById('productDescription').value
            };
            
            // Add to products array
            products.push(newProduct);
            
            // Update display
            displayProducts();
            
            // Close modal
            document.querySelector('.modal').remove();
            
            // Show success message
            showAlert('success', 'تم إضافة المنتج بنجاح');
            
            // Update statistics
            updateProductsStatistics();
        }
        
        // Test Google Sheets connection
        async function testGoogleSheetsConnection() {
            try {
                showLoadingIndicator();
                
                console.log('Testing Google Sheets connection...');
                console.log('Web App URL:', window.dataSyncManager.sheetsAPI.webAppUrl);
                
                // Update status to checking
                updateSyncStatus(false, 'جاري اختبار الاتصال...');
                
                // Check internet connection first
                if (!navigator.onLine) {
                    showAlert('danger', 'لا يوجد اتصال بالإنترنت. يرجى التحقق من اتصالك.');
                    updateSyncStatus(false, 'لا يوجد اتصال');
                    hideLoadingIndicator();
                    return;
                }
                
                // Force re-check of Google Sheets availability
                await window.dataSyncManager.checkGoogleSheetsAvailability();
                
                console.log('After checkGoogleSheetsAvailability:', window.dataSyncManager.isUsingGoogleSheets);
                
                if (window.dataSyncManager.isUsingGoogleSheets) {
                    const result = await window.dataSyncManager.sheetsAPI.testConnection();
                    
                    if (result.success) {
                        showAlert('success', 'اتصال ناجح بـ Google Sheets! تم العثور على ' + result.data.length + ' منتج');
                        console.log('Test data:', result.data);
                        
                        // Force update the global state
                        window.dataSyncManager.isUsingGoogleSheets = true;
                        
                        // Update status to active
                        updateSyncStatus(true, 'كل 5 دقائق');
                        
                        // Auto-sync after successful connection
                        setTimeout(() => {
                            console.log('Starting auto-sync after successful test...');
                            syncGoogleSheets();
                        }, 1000);
                    } else {
                        showAlert('danger', 'فشل الاتصال: ' + result.error);
                        console.error('Connection test failed:', result.error);
                        updateSyncStatus(false, 'فشل الاتصال: ' + result.error);
                    }
                } else {
                    showAlert('warning', 'Google Sheets غير متاح، يرجى التحقق من الإعدادات');
                    console.log('Google Sheets not available after check');
                    updateSyncStatus(false, 'غير متاح');
                }
            } catch (error) {
                console.error('Test connection error:', error);
                showAlert('danger', 'حدث خطأ أثناء اختبار الاتصال: ' + error.message);
                updateSyncStatus(false, 'حدث خطأ: ' + error.message);
            } finally {
                hideLoadingIndicator();
            }
        }
        
        // Loading indicator functions
        function showLoadingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'loadingIndicator';
            indicator.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center';
            indicator.style.backgroundColor = 'rgba(0,0,0,0.5)';
            indicator.style.zIndex = '9999';
            indicator.innerHTML = `
                <div class="bg-white p-4 rounded-3 text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>جاري المزامنة...</h5>
                    <p class="text-muted">يرجى الانتظار</p>
                </div>
            `;
            document.body.appendChild(indicator);
        }

        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.querySelector('.main-content').insertAdjacentHTML('afterbegin', alertHtml);
            
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) alert.remove();
            }, 5000);
        }
        
        // Orders Management Functions
        async function loadOrders() {
            try {
                console.log('Loading orders...');
                
                // Use Google Sheets if available, otherwise use mock API
                if (window.dataSyncManager && window.dataSyncManager.isUsingGoogleSheets) {
                    // Load from Google Sheets
                    const ordersData = await window.dataSyncManager.sheetsAPI.getSheetData('orders');
                    const customersData = await window.dataSyncManager.sheetsAPI.getSheetData('customers');
                    const orderItemsData = await window.dataSyncManager.sheetsAPI.getSheetData('orderItems');
                    const productsData = await window.dataSyncManager.sheetsAPI.getSheetData('products');
                    
                    // Store global data for order details
                    window.orderItemsData = orderItemsData;
                    window.productsData = productsData;
                    
                    // Convert to order objects with proper customer names
                    orders = ordersData.map((row, index) => {
                        const customer = customersData.find(c => c[0] === row[1]);
                        const customerName = customer ? customer[1] : 'عميل غير معروف';
                        
                        return {
                            id: index + 1,
                            order_id: row[0] || '',
                            customer_id: row[1] || '',
                            customer_name: customerName,
                            phone: customer ? customer[2] || '' : '',
                            address: customer ? customer[3] || '' : '',
                            total_price: parseFloat(row[2]) || 0,
                            order_status: row[3] || 'pending',
                            order_date: row[4] || new Date().toLocaleDateString('fr-FR'),
                            items: row[5] || ''
                        };
                    });
                } else {
                    // Fallback to mock API
                    const response = await fetch('/admin/api/orders');
                    orders = await response.json();
                }
                
                displayOrders();
                updateOrdersStatistics();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                showAlert('danger', 'حدث خطأ أثناء تحميل الطلبات');
            }
        }
        
        function displayOrders() {
            const tbody = document.getElementById('ordersTableBody');
            if (!tbody) return;
            
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5"><i class="fas fa-inbox fa-3x text-muted mb-3"></i><p>لا توجد طلبات حالياً</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = orders.map(order => `
                <tr onclick="showOrderDetails(${order.id})" style="cursor: pointer;">
                    <td><strong>${order.order_id}</strong></td>
                    <td>${order.customer_name}</td>
                    <td class="text-primary fw-bold">${formatCurrency(order.total_price)} دج</td>
                    <td>
                        <span class="status-badge status-${order.order_status}">
                            ${getOrderStatusText(order.order_status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-icon btn-outline-primary" onclick="event.stopPropagation(); showOrderDetails(${order.id})" title="عرض التفاصيل">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-icon btn-outline-secondary" onclick="event.stopPropagation(); printOrderDetails(${order.id})" title="طباعة">
                            <i class="fas fa-print"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function updateOrdersStatistics() {
            const totalOrders = orders.length;
            const pendingOrders = orders.filter(o => o.order_status === 'pending').length;
            const completedOrders = orders.filter(o => o.order_status === 'delivered').length;
            const totalRevenue = orders.reduce((sum, o) => sum + o.total_price, 0);
            
            // Use new IDs for the orders page statistics
            document.getElementById('orders-totalOrders').textContent = totalOrders;
            document.getElementById('orders-pendingOrders').textContent = pendingOrders;
            document.getElementById('orders-completedOrders').textContent = completedOrders;
            document.getElementById('orders-totalRevenue').textContent = formatCurrency(totalRevenue) + ' دج';
        }
        
        function getOrderStatusText(status) {
            switch(status) {
                case 'pending': return 'معلق';
                case 'processing': return 'قيد المعالجة';
                case 'shipped': return 'تم الشحن';
                case 'delivered': return 'تم التسليم';
                case 'cancelled': return 'ملغي';
                default: return status;
            }
        }
        
        function refreshOrders() {
            loadOrders();
        }
        
        function filterOrders() {
            const statusFilter = document.getElementById('orderStatusFilter').value;
            const searchTerm = document.getElementById('orderSearch').value.toLowerCase();
            
            let filteredOrders = orders;
            
            if (statusFilter) {
                filteredOrders = filteredOrders.filter(o => o.order_status === statusFilter);
            }
            
            if (searchTerm) {
                filteredOrders = filteredOrders.filter(o => 
                    o.order_id.toLowerCase().includes(searchTerm) ||
                    o.customer_name.toLowerCase().includes(searchTerm) ||
                    o.phone.includes(searchTerm)
                );
            }
            
            // Temporarily replace orders array and display
            const tempOrders = orders;
            orders = filteredOrders;
            displayOrders();
            orders = tempOrders;
        }
        
        function searchOrders() {
            filterOrders();
        }
        
        function showOrderDetails(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            
            const detailsContainer = document.getElementById('orderDetailsContainer');
            if (!detailsContainer) return;
            
            // Make sure container is not centered anymore
            detailsContainer.classList.remove('d-flex', 'align-items-center', 'justify-content-center');

            // Get order items and product details
            const orderItems = window.orderItemsData ? window.orderItemsData.filter(item => item[1] === order.order_id) : [];
            const productsData = window.productsData || [];
            
            // Calculate items with product details
            const itemsWithProducts = orderItems.map(item => {
                const product = productsData.find(p => p[0] === item[2]); // product_id is in column 2
                
                // Try to find quantity_per_pack in different possible columns
                let quantityPerPack = 1;
                if (product) {
                    // Check common columns for quantity_per_pack
                    quantityPerPack = product[8] || product[7] || product[6] || 1;
                }
                
                return {
                    product_id: item[2],      // column 2: product_id
                    product_name: product ? product[2] : `منتج ${item[2]}`, // column 2: product_name or fallback to ID
                    quantity: parseInt(item[3]) || 0,     // column 3: quantity
                    quantity_per_pack: quantityPerPack,
                    unit_price: parseFloat(item[4]) || 0, // column 4: unit_price
                    total_price: parseFloat(item[5]) || 0 // column 5: subtotal
                };
            });
            
            const detailsHtml = `
                <div class="order-details-view w-100">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">طلب رقم: <span class="text-primary">${order.order_id}</span></h5>
                        <span class="status-badge status-${order.order_status}">${getOrderStatusText(order.order_status)}</span>
                    </div>
                    <p class="text-muted small mb-4"><i class="fas fa-clock me-1"></i> ${formatDateTime(order.order_date)}</p>

                    <!-- Customer Details Card -->
                    <div class="card mb-3">
                        <div class="card-header bg-light py-2">
                            <h6 class="mb-0"><i class="fas fa-user me-2"></i>معلومات العميل</h6>
                        </div>
                        <div class="card-body">
                            <p><strong>الاسم:</strong> ${order.customer_name}</p>
                            <p><strong>الهاتف:</strong> ${order.phone}</p>
                            <p class="mb-0"><strong>العنوان:</strong> ${order.address}</p>
                        </div>
                    </div>

                    <!-- Order Items Card -->
                    <h6 class="mb-2 mt-4"><i class="fas fa-boxes me-2"></i>المنتجات المطلوبة</h6>
                    <div class="order-items-container" style="max-height: 220px; overflow-y: auto; padding-right: 5px;">
                        ${itemsWithProducts.length > 0 ? `
                            <table class="table table-sm">
                                <tbody>
                                    ${itemsWithProducts.map(item => `
                                        <tr>
                                            <td>
                                                ${item.product_name}<br>
                                                <small class="text-muted">${formatQuantity(item.quantity, item.quantity_per_pack)} | بسعر ${formatCurrency(item.unit_price)} دج</small>
                                            </td>
                                            <td class="text-end fw-bold align-middle">${formatCurrency(item.total_price)} دج</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <div class="alert alert-info">لا توجد تفاصيل للمنتجات في هذا الطلب</div>
                        `}
                    </div>

                    <!-- Totals -->
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-0">الإجمالي الكلي:</h6>
                            <h6 class="mb-0 text-primary fw-bold">${formatCurrency(order.total_price)} دج</h6>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="mt-4 text-center">
                        <div class="btn-group" role="group">
                            <button class="btn btn-primary" onclick="editOrder(${order.id})"><i class="fas fa-edit me-1"></i> تعديل</button>
                            <button class="btn btn-success" onclick="updateOrderStatus(${order.id})"><i class="fas fa-check me-1"></i> تحديث الحالة</button>
                            <button class="btn btn-info" onclick="printOrderDetails(${order.id})"><i class="fas fa-print me-1"></i> طباعة</button>
                        </div>
                    </div>
                </div>
            `;
            
            detailsContainer.innerHTML = detailsHtml;
            
            // Highlight selected row
            document.querySelectorAll('#ordersTableBody tr').forEach(tr => tr.classList.remove('table-active'));
            const selectedRow = document.querySelector(`#ordersTableBody tr[onclick="showOrderDetails(${id})"]`);
            if (selectedRow) {
                selectedRow.classList.add('table-active');
            }
        }
        
        function viewOrder(id) {
            const order = orders.find(o => o.id === id);
            if (order) {
                showAlert('info', `تفاصيل الطلب ${order.order_id}: ${order.items}`);
            }
        }
        
        function printOrderDetails(id) {
            const order = orders.find(o => o.id === id);
            if (!order) return;
            
            // Get order items and product details
            const orderItems = window.orderItemsData ? window.orderItemsData.filter(item => item[1] === order.order_id) : [];
            const productsData = window.productsData || [];
            
            // Calculate items with product details
            const itemsWithProducts = orderItems.map(item => {
                const product = productsData.find(p => p[0] === item[2]);
                
                // Try to find quantity_per_pack in different possible columns
                let quantityPerPack = 1;
                if (product) {
                    // Check common columns for quantity_per_pack
                    quantityPerPack = product[8] || product[7] || product[6] || 1;
                }
                
                // Debug logging for print
                console.log('Print - Order item:', item);
                console.log('Print - Found product:', product);
                console.log('Print - Product columns:', product);
                console.log('Print - Quantity per pack:', quantityPerPack);
                console.log('Print - Formatted quantity:', formatQuantity(parseInt(item[3]) || 0, quantityPerPack));
                
                return {
                    product_name: product ? product[2] : `منتج ${item[2]}`,
                    quantity: parseInt(item[3]) || 0,
                    quantity_per_pack: quantityPerPack,
                    unit_price: parseFloat(item[4]) || 0,
                    total_price: parseFloat(item[5]) || 0
                };
            });
            
            // Create print content
            const printContent = `
                <div style="direction: rtl; text-align: right; font-family: Arial, sans-serif; padding: 20px;">
                    <h2 style="text-align: center; margin-bottom: 30px;">تفاصيل الطلب</h2>
                    
                    <div style="margin-bottom: 30px;">
                        <h3>معلومات الطلب</h3>
                        <p><strong>رقم الطلب:</strong> ${order.order_id}</p>
                        <p><strong>العميل:</strong> ${order.customer_name}</p>
                        <p><strong>الهاتف:</strong> ${order.phone}</p>
                        <p><strong>العنوان:</strong> ${order.address}</p>
                        <p><strong>التاريخ:</strong> ${formatDateTime(order.order_date)}</p>
                        <p><strong>الحالة:</strong> ${getOrderStatusText(order.order_status)}</p>
                        <p><strong>الإجمالي:</strong> ${formatCurrency(order.total_price)} دج</p>
                    </div>
                    
                    <div>
                        <h3>تفاصيل المنتجات</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">المنتج</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">الكمية</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">سعر الوحدة</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">الإجمالي</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsWithProducts.map(item => `
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${item.product_name}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${formatQuantity(item.quantity, item.quantity_per_pack)}</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.unit_price)} دج</td>
                                        <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(item.total_price)} دج</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="background-color: #f8f9fa; font-weight: bold;">
                                    <td colspan="3" style="border: 1px solid #ddd; padding: 8px;">الإجمالي الكلي:</td>
                                    <td style="border: 1px solid #ddd; padding: 8px;">${formatCurrency(order.total_price)} دج</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #666;">
                        <p>تمت الطباعة في ${new Date().toLocaleString('ar-DZ')}</p>
                    </div>
                </div>
            `;
            
            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>طلب رقم ${order.order_id}</title>
                    <style>
                        @media print {
                            body { margin: 0; }
                            @page { margin: 1cm; }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        function editOrder(id) {
            showAlert('info', 'صفحة تعديل الطلب قيد التطوير');
        }
        
        function updateOrderStatus(id) {
            const order = orders.find(o => o.id === id);
            if (order) {
                // Populate modal with order data
                document.getElementById('modalOrderId').value = order.order_id || order.id;
                document.getElementById('modalCurrentStatus').value = getOrderStatusText(order.order_status);
                document.getElementById('modalNewStatus').value = order.order_status;
                document.getElementById('modalStatusNotes').value = '';
                
                // Store current order ID for saving
                window.currentOrderId = id;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('orderStatusModal'));
                modal.show();
            }
        }
        
        function saveOrderStatus() {
            const id = window.currentOrderId;
            const order = orders.find(o => o.id === id);
            
            if (order) {
                const newStatus = document.getElementById('modalNewStatus').value;
                const notes = document.getElementById('modalStatusNotes').value;
                
                // Update local order
                order.order_status = newStatus;
                
                // Update displays immediately
                displayOrders();
                updateOrdersStatistics();
                
                // If order details are being shown, update them too
                const detailsContainer = document.getElementById('orderDetailsContainer');
                if (detailsContainer && detailsContainer.innerHTML.includes(order.order_id)) {
                    showOrderDetails(id);
                }
                
                // Save to Google Sheets if available
                if (window.dataSyncManager && window.dataSyncManager.isUsingGoogleSheets) {
                    updateOrderStatusInSheets(order.order_id, newStatus, notes).then(() => {
                        // Refresh orders from sheets after successful update
                        setTimeout(() => {
                            loadOrders();
                        }, 1000);
                    });
                } else {
                    showAlert('success', 'تم تحديث حالة الطلب بنجاح');
                }
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('orderStatusModal'));
                modal.hide();
            }
        }
        
        async function updateOrderStatusInSheets(orderId, newStatus, notes) {
            try {
                console.log(`Updating status for order ${orderId} to ${newStatus}`);
        
                if (!window.dataSyncManager || !window.dataSyncManager.isUsingGoogleSheets) {
                    throw new Error('Google Sheets API not available');
                }
        
                const ordersData = await window.dataSyncManager.sheetsAPI.getSheetData('orders');
                if (!ordersData || ordersData.length === 0) {
                    throw new Error('No orders data found');
                }
        
                const orderIndex = ordersData.findIndex(order => order[0] === orderId);
                if (orderIndex === -1) {
                    throw new Error(`Order ${orderId} not found in sheets`);
                }
        
                // The data from getSheetData is without header, so the row in the sheet is index + 2
                const sheetRowNumber = orderIndex + 2;
        
                // Get the full row data and update the status
                let updatedRow = ordersData[orderIndex];
                updatedRow[3] = newStatus; // Assuming status is in the 4th column (index 3)

                // This requires a working `updateRow` in your API and an `updateOrder` action in Apps Script
                await window.dataSyncManager.sheetsAPI.updateRow('orders', sheetRowNumber, updatedRow);
        
                showAlert('success', 'تم تحديث حالة الطلب بنجاح وحفظه في Google Sheets');
            } catch (error) {
                console.error('Error updating order status in sheets:', error);
                showAlert('warning', `تم تحديث الحالة محلياً فقط، حدث خطأ في المزامنة: ${error.message}`);
            }
        }
        
        function addNewOrder() {
            showAlert('info', 'صفحة إضافة طلب جديد قيد التطوير');
        }
        
        // Notification System
        let notificationId = 0;
        let knownOrders = new Set();
        let notificationCheckInterval;
        
        // Initialize notification system
        function initializeNotificationSystem() {
            console.log('Initializing notification system...');
            
            // First, load all existing orders to avoid showing notifications for them
            loadExistingOrders().then(() => {
                // Start checking for new orders after loading existing ones
                startNotificationCheck();
            });
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    console.log('Notification permission:', permission);
                });
            }
        }
        
        // Load existing orders to establish baseline
        async function loadExistingOrders() {
            try {
                if (!window.dataSyncManager || !window.dataSyncManager.isUsingGoogleSheets) {
                    console.log('Google Sheets not available, skipping existing orders load');
                    return;
                }
                
                const ordersData = await window.dataSyncManager.sheetsAPI.getSheetData('orders');
                console.log('Loading existing orders:', ordersData.length, 'orders found');
                
                // Add all existing order IDs to knownOrders set
                ordersData.forEach(order => {
                    if (order[0]) { // Make sure order ID exists
                        knownOrders.add(order[0]);
                    }
                });
                
                console.log('Known orders baseline established with', knownOrders.size, 'orders');
                
            } catch (error) {
                console.error('Error loading existing orders:', error);
            }
        }
        
        // Start checking for new orders periodically
        function startNotificationCheck() {
            // Check immediately
            checkForNewOrders();
            
            // Then check every 5 minutes (300,000 ms)
            notificationCheckInterval = setInterval(checkForNewOrders, 300000);
            console.log('Started checking for new orders every 5 minutes');
        }
        
        // Check for new orders
        async function checkForNewOrders() {
            try {
                if (!window.dataSyncManager || !window.dataSyncManager.isUsingGoogleSheets) {
                    console.log('Skipping order check - Google Sheets not available');
                    return;
                }
                
                console.log('Checking for new orders...');
                const ordersData = await window.dataSyncManager.sheetsAPI.getSheetData('orders');
                const currentOrderIds = new Set(ordersData.map(order => order[0]));
                
                console.log('Total orders in sheet:', ordersData.length);
                console.log('Known orders count:', knownOrders.size);
                
                // Find new orders (orders that exist now but weren't in knownOrders)
                const newOrders = ordersData.filter(order => !knownOrders.has(order[0]));
                
                if (newOrders.length > 0) {
                    console.log('Found truly new orders:', newOrders.length);
                    console.log('New order IDs:', newOrders.map(order => order[0]));
                    
                    // Add new orders to known orders to prevent duplicate notifications
                    newOrders.forEach(order => knownOrders.add(order[0]));
                    
                    // Show notifications for each new order
                    newOrders.forEach(order => {
                        showNewOrderNotification(order);
                    });
                    
                    // Update badge
                    updateNewOrdersBadge(newOrders.length);
                } else {
                    console.log('No new orders found');
                }
                
            } catch (error) {
                console.error('Error checking for new orders:', error);
            }
        }
        
        // Show notification for new order
        function showNewOrderNotification(order) {
            const orderId = order[0];
            const customerId = order[1];
            const totalPrice = order[2];
            const status = order[3];
            
            // Play sound
            playNotificationSound();
            
            // Show browser notification if permitted
            if ('Notification' in window && Notification.permission === 'granted') {
                const browserNotification = new Notification('طلب جديد!', {
                    body: `طلب رقم ${orderId} - ${formatCurrency(totalPrice)} دج`,
                    icon: '/favicon.ico',
                    tag: orderId,
                    requireInteraction: true
                });
                
                browserNotification.onclick = () => {
                    window.focus();
                    showPage('orders');
                    showOrderDetails(parseInt(orderId.replace('ord-', '')) || 1);
                    browserNotification.close();
                };
                
                // Auto close after 10 seconds
                setTimeout(() => browserNotification.close(), 10000);
            }
            
            // Show in-app notification
            showInAppNotification(orderId, totalPrice);
        }
        
        // Show in-app notification
        function showInAppNotification(orderId, totalPrice) {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const id = ++notificationId;
            const notification = document.createElement('div');
            notification.className = 'notification new-order';
            notification.id = `notification-${id}`;
            
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">
                        <i class="fas fa-shopping-bag"></i>
                        طلب جديد
                    </div>
                    <button class="notification-close" onclick="closeNotification(${id})">×</button>
                </div>
                <div class="notification-body">
                    <strong>طلب رقم ${orderId}</strong><br>
                    المبلغ: ${formatCurrency(totalPrice)} دج<br>
                    الحالة: معلق
                </div>
                <div class="notification-actions">
                    <button class="notification-btn-primary" onclick="viewOrderNotification('${orderId}')">
                        عرض التفاصيل
                    </button>
                    <button class="notification-btn-secondary" onclick="closeNotification(${id})">
                        إغلاق
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto remove after 15 seconds
            setTimeout(() => closeNotification(id), 15000);
        }
        
        // Close notification
        function closeNotification(id) {
            const notification = document.getElementById(`notification-${id}`);
            if (notification) {
                notification.classList.add('removing');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }
        
        // View order from notification
        function viewOrderNotification(orderId) {
            showPage('orders');
            // Find the order and show details
            const orderIndex = parseInt(orderId.replace('ord-', '')) || 1;
            setTimeout(() => showOrderDetails(orderIndex), 500);
        }
        
        // Play notification sound
        function playNotificationSound() {
            const audio = document.getElementById('notificationSound');
            const soundIndicator = document.getElementById('soundIndicator');
            
            if (audio) {
                audio.play().then(() => {
                    // Show sound indicator
                    if (soundIndicator) {
                        soundIndicator.classList.add('show');
                        setTimeout(() => {
                            soundIndicator.classList.remove('show');
                        }, 2000);
                    }
                }).catch(error => {
                    console.log('Could not play notification sound:', error);
                });
            }
        }
        
        // Update new orders badge
        function updateNewOrdersBadge(count) {
            const badge = document.getElementById('newOrdersCount');
            const ordersLink = document.querySelector('a[onclick="showPage(\'orders\')"]');
            
            if (badge && ordersLink) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                    ordersLink.classList.add('orders-badge-blink');
                    
                    // Remove blink animation after 3 seconds
                    setTimeout(() => {
                        ordersLink.classList.remove('orders-badge-blink');
                    }, 3000);
                }
            }
        }
        
        // Clear new orders badge when viewing orders page
        function clearNewOrdersBadge() {
            const badge = document.getElementById('newOrdersCount');
            if (badge) {
                badge.style.display = 'none';
                badge.textContent = '0';
            }
        }
        
        // Categories Management Functions
        let categories = [];
        let googleSheetsAPI;
        
        // Initialize Google Sheets API
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof GoogleSheetsAPI !== 'undefined') {
                googleSheetsAPI = new GoogleSheetsAPI();
                console.log('Google Sheets API initialized');
            } else {
                console.warn('Google Sheets API not available');
            }
        });
        
        // Load fallback categories
        async function loadFallbackCategories() {
            console.log('Loading fallback categories...');
            
            // Define real categories data
            const realCategories = [
                { id: 1, category_id: 'ctg-001', category_name: 'تست', image_url: 'https://res.cloudinary.com/dgtnnmpgz/image/upload/v1770244006/logo_7_by5bdn.png', product_count: 0 },
                { id: 2, category_id: 'ctg-002', category_name: 'بينقو', image_url: 'https://res.cloudinary.com/dgtnnmpgz/image/upload/v1770244005/logo_4_hupdyh.jpg', product_count: 0 },
                { id: 3, category_id: 'ctg-003', category_name: 'مولبيد', image_url: 'https://res.cloudinary.com/dgtnnmpgz/image/upload/v1770244006/logo_6_ptuj7y.png', product_count: 0 },
                { id: 4, category_id: 'ctg-004', category_name: 'مولفيكس', image_url: 'https://res.cloudinary.com/dgtnnmpgz/image/upload/v1770244006/logo_5_umu2gd.png', product_count: 0 },
                { id: 5, category_id: 'ctg-005', category_name: 'بيبام', image_url: 'https://res.cloudinary.com/dgtnnmpgz/image/upload/v1770244005/logo_3_cadwia.png', product_count: 0 },
                { id: 6, category_id: 'ctg-006', category_name: 'كود كير', image_url: 'https://res.cloudinary.com/dgtnnmpgz/image/upload/v1770244006/logo_1_razfy8.png', product_count: 0 }
            ];
            
            // Save to localStorage for future use
            localStorage.setItem('categoryFallbackData', JSON.stringify(realCategories));
            
            // Try to load from localStorage first
            const fallbackData = localStorage.getItem('categoryFallbackData');
            if (fallbackData) {
                try {
                    categories = JSON.parse(fallbackData);
                    displayCategories();
                    updateCategoryStats();
                    console.log('Loaded categories from localStorage fallback');
                    return;
                } catch (error) {
                    console.warn('Failed to parse fallback data:', error);
                }
            }
            
            // Use hardcoded fallback data as final option
            categories = realCategories;
            displayCategories();
            updateCategoryStats();
            
            // Load categories into product and cart filters
            loadCategoriesIntoFilter();
            loadCategoriesIntoCartFilter();
            
            console.log('Loaded hardcoded fallback categories');
        }
        
        async function loadCategories() {
            try {
                console.log('🔄 Loading categories with intelligent cache...');
                
                // Use intelligent cache if available
                if (window.intelligentCache) {
                    const result = await window.intelligentCache.get('categories');
                    
                    if (result.success) {
                        categories = result.data;
                        displayCategories();
                        updateCategoryStats();
                        
                        // Load categories into product and cart filters
                        loadCategoriesIntoFilter();
                        loadCategoriesIntoCartFilter();
                        
                        if (result.fromCache) {
                            const ageText = result.stale ? 'قديمة' : `${Math.round(result.age / 1000)} ثانية`;
                            showNotification(`تم تحميل الأصناف من الكاش (${ageText})`, 'info');
                        } else {
                            showNotification('تم تحميل الأصناف من Google Sheets', 'success');
                        }
                        return;
                    } else {
                        showNotification('فشل في تحميل الأصناف: ' + result.error, 'danger');
                    }
                }
                
                // Fallback to original method if intelligent cache not available
                console.log('🔄 Using fallback loading method...');
                
                // Load products first if not already loaded
                if (products.length === 0) {
                    try {
                        await loadProducts();
                    } catch (error) {
                        console.warn('Could not load products for category counts:', error);
                    }
                }
                
                // Try to load from Google Sheets directly
                if (window.googleSheetsAPI && window.googleSheetsAPI.isConfigured()) {
                    try {
                        console.log('Loading categories from Google Sheets...');
                        const response = await window.googleSheetsAPI.getSheetData('category');
                        
                        if (response.success && response.data) {
                            console.log('Successfully loaded categories from Google Sheets:', response.data);
                            categories = response.data.map((category, index) => ({
                                id: category.id || index + 1,
                                category_id: category.category_id || '',
                                category_name: category.category_name || '',
                                image_url: category.image_url || '',
                                product_count: category.product_count || 0
                            }));
                            
                            displayCategories();
                            updateCategoryStats();
                            console.log('Categories loaded and displayed successfully');
                        } else {
                            throw new Error(response.error || 'Failed to load categories');
                        }
                    } catch (error) {
                        console.error('Error loading categories from Google Sheets:', error);
                        // Try fallback data
                        await loadFallbackCategories();
                    }
                } else {
                    console.warn('Google Sheets API not configured, using fallback data');
                    await loadFallbackCategories();
                }
            } catch (error) {
                console.error('Error in loadCategories:', error);
                // Final fallback
                await loadFallbackCategories();
            }
        }
        
        function displayCategories() {
            const grid = document.getElementById('categoriesGrid');
            if (!grid) {
                console.error('categoriesGrid element not found');
                return;
            }
            
            console.log('Displaying categories:', categories.length);
            
            if (categories.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center"><i class="fas fa-tags text-muted me-2"></i>لا توجد أصناف حالياً</div>';
                return;
            }
            
            try {
                grid.innerHTML = categories.map(category => {
                    console.log('Processing category:', category.category_name);
                    return `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 category-card">
                            <img src="${category.image_url || `https://picsum.photos/seed/${category.category_id}/300/200.jpg`}" 
                                 class="card-img-top category-image" alt="${category.category_name}"
                                 onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                            <div class="card-body">
                                <h5 class="card-title">${category.category_name}</h5>
                                <p class="card-text text-muted small">${category.category_id}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-primary">
                                        <i class="fas fa-box me-1"></i>
                                        ${category.product_count} منتج
                                    </span>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${category.id})" title="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${category.id})" title="حذف">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
                
                console.log('Categories displayed successfully');
            } catch (error) {
                console.error('Error displaying categories:', error);
                grid.innerHTML = '<div class="col-12 text-center"><p class="text-danger">حدث خطأ في عرض الأصناف</p></div>';
            }
        }
        
        function updateCategoriesStatistics() {
            const totalCategories = categories.length;
            const productsInCategories = categories.reduce((sum, cat) => sum + cat.product_count, 0);
            const avgProductsPerCategory = totalCategories > 0 ? Math.round(productsInCategories / totalCategories) : 0;
            
            document.getElementById('totalCategories').textContent = totalCategories;
            document.getElementById('productsInCategories').textContent = productsInCategories;
            document.getElementById('avgProductsPerCategory').textContent = avgProductsPerCategory;
        }
        
        // Show cache statistics
        function showCacheStats() {
            if (window.intelligentCache) {
                const stats = window.intelligentCache.getStats();
                const statsText = `
                    إحصائيات الكاش:
                    - العناصر المخزنة: ${stats.totalItems}
                    - آخر مزامنة: ${new Date(stats.lastSync.categories || 0).toLocaleTimeString('ar-SA')}
                    - الحالة: ${navigator.onLine ? 'متصل' : 'غير متصل'}
                `;
                alert(statsText);
            } else {
                alert('نظام الكاش الذكي غير متاح');
            }
        }
        
        // Clear cache
        function clearCache() {
            if (window.intelligentCache && confirm('هل أنت متأكد من مسح الكاش؟')) {
                window.intelligentCache.clear();
                showNotification('تم مسح الكاش بنجاح', 'success');
            }
        }
        
        // Refresh categories with intelligent cache
        async function refreshCategories() {
            if (window.intelligentCache) {
                console.log('🔄 Force refreshing categories with intelligent cache...');
                showNotification('جاري تحديث الأصناف...', 'info');
                
                try {
                    const result = await window.intelligentCache.get('categories', true); // forceRefresh = true
                    if (result.success) {
                        categories = result.data;
                        displayCategories();
                        updateCategoryStats();
                        showNotification('تم تحديث الأصناف بنجاح', 'success');
                    } else {
                        showNotification('فشل في تحديث الأصناف: ' + result.error, 'danger');
                    }
                } catch (error) {
                    console.error('Error refreshing categories:', error);
                    showNotification('حدث خطأ في تحديث الأصناف', 'danger');
                }
            } else {
                // Fallback to original refresh
                localStorage.removeItem('useLocalData'); // Force refresh from API
                await loadCategories();
            }
        }
        
        function searchCategories() {
            const searchTerm = document.getElementById('categorySearch').value.toLowerCase();
            
            let filteredCategories = categories;
            
            if (searchTerm) {
                filteredCategories = filteredCategories.filter(cat => 
                    cat.category_name.toLowerCase().includes(searchTerm) ||
                    cat.category_id.toLowerCase().includes(searchTerm)
                );
            }
            
            // Temporarily replace categories array and display
            const tempCategories = categories;
            categories = filteredCategories;
            displayCategories();
            categories = tempCategories;
        }
        
        function sortCategories() {
            const sortBy = document.getElementById('categorySort').value;
            
            let sortedCategories = [...categories];
            
            switch(sortBy) {
                case 'name':
                    sortedCategories.sort((a, b) => a.category_name.localeCompare(b.category_name));
                    break;
                case 'id':
                    sortedCategories.sort((a, b) => a.category_id.localeCompare(b.category_id));
                    break;
                case 'products':
                    sortedCategories.sort((a, b) => b.product_count - a.product_count);
                    break;
            }
            
            // Temporarily replace categories array and display
            const tempCategories = categories;
            categories = sortedCategories;
            displayCategories();
            categories = tempCategories;
        }
        
        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (category) {
                const newName = prompt('اسم الصنف الجديد:', category.category_name);
                if (newName && newName.trim()) {
                    category.category_name = newName.trim();
                    displayCategories();
                    
                    // Update in Google Sheets if available
                    if (window.dataSyncManager && window.dataSyncManager.isUsingGoogleSheets) {
                        window.dataSyncManager.sheetsAPI.updateSheetData('category', id, [
                            category.category_id,
                            category.category_name,
                            category.image_url
                        ]).then(() => {
                            showAlert('success', 'تم تحديث الصنف في Google Sheets بنجاح');
                        }).catch(error => {
                            console.error('Error updating category in Google Sheets:', error);
                            showAlert('warning', 'تم التحديث محلياً فقط');
                        });
                    } else {
                        showAlert('success', 'تم تحديث الصنف بنجاح');
                    }
                }
            }
        }
        
        function deleteCategory(id) {
            const category = categories.find(c => c.id === id);
            if (category) {
                if (confirm(`هل أنت متأكد من حذف صنف "${category.category_name}"؟`)) {
                    categories = categories.filter(c => c.id !== id);
                    displayCategories();
                    updateCategoriesStatistics();
                    showAlert('success', 'تم حذف الصنف بنجاح');
                }
            }
        }
        
        function addNewCategory() {
            const name = prompt('اسم الصنف الجديد:');
            if (name && name.trim()) {
                const newCategory = {
                    id: categories.length + 1,
                    category_id: 'CAT' + String(categories.length + 1).padStart(3, '0'),
                    category_name: name.trim(),
                    image_url: '',
                    product_count: 0
                };
                categories.push(newCategory);
                displayCategories();
                updateCategoriesStatistics();
                showAlert('success', 'تم إضافة الصنف بنجاح');
            }
        }

        // Update Sales Statistics
        function updateSalesStatistics() {
            // Calculate sales data from orders
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            let todaySales = 0;
            let weeklySales = 0;
            let monthlySales = 0;
            let totalSales = 0;
            
            orders.forEach(order => {
                const orderDate = new Date(order.created_at);
                const orderTotal = parseFloat(order.total) || 0;
                
                totalSales += orderTotal;
                
                if (orderDate >= today) {
                    todaySales += orderTotal;
                }
                
                if (orderDate >= weekAgo) {
                    weeklySales += orderTotal;
                }
                
                if (orderDate >= monthAgo) {
                    monthlySales += orderTotal;
                }
            });
            
            // Update the DOM with formatted numbers
            document.getElementById('todaySales').textContent = formatCurrency(todaySales);
            document.getElementById('weeklySales').textContent = formatCurrency(weeklySales);
            document.getElementById('monthlySales').textContent = formatCurrency(monthlySales);
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
        }

        // Auto-update sales statistics every 5 minutes instead of 30 seconds
        setInterval(updateSalesStatistics, 300000);
        
        // Notification control
        let notificationsEnabled = true;
        
        function toggleNotifications() {
            notificationsEnabled = !notificationsEnabled;
            const icon = document.getElementById('notificationIcon');
            const toggle = document.getElementById('notificationToggle');
            
            if (notificationsEnabled) {
                icon.className = 'fas fa-bell';
                toggle.classList.remove('text-muted');
                
                // Re-initialize the notification system to reload existing orders
                initializeNotificationSystem();
                showAlert('success', 'تم تفعيل الإشعارات');
            } else {
                icon.className = 'fas fa-bell-slash';
                toggle.classList.add('text-muted');
                
                // Stop checking for new orders
                if (notificationCheckInterval) {
                    clearInterval(notificationCheckInterval);
                    notificationCheckInterval = null;
                }
                showAlert('info', 'تم إيقاف الإشعارات');
            }
        }
        
        // Function to manually reset notification baseline
        function resetNotificationBaseline() {
            console.log('Resetting notification baseline...');
            knownOrders.clear();
            loadExistingOrders().then(() => {
                showAlert('success', 'تم إعادة تعيين قاعدة الإشعارات بنجاح');
            });
        }
        
        // Modify showNewOrderNotification to respect the notification setting
        const originalShowNewOrderNotification = showNewOrderNotification;
        showNewOrderNotification = function(order) {
            if (!notificationsEnabled) {
                console.log('Notifications disabled - skipping notification for order:', order[0]);
                return;
            }
            return originalShowNewOrderNotification(order);
        };
        
        // Initial call to populate sales statistics
        updateSalesStatistics();
    </script>
    
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <!-- Sound Indicator -->
    <div class="sound-indicator" id="soundIndicator">
        <i class="fas fa-volume-up"></i>
        <span>تم تشغيل صوت التنبيه</span>
    </div>
    
    <!-- Audio for notifications -->
    <audio id="notificationSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBiuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
    </audio>
    
    <!-- Order Status Update Modal -->
    <div class="modal fade" id="orderStatusModal" tabindex="-1" aria-labelledby="orderStatusModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderStatusModalLabel">
                        <i class="fas fa-edit me-2"></i>
                        تحديث حالة الطلب
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">رقم الطلب:</label>
                        <input type="text" class="form-control" id="modalOrderId" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الحالة الحالية:</label>
                        <input type="text" class="form-control" id="modalCurrentStatus" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الحالة الجديدة:</label>
                        <select class="form-select" id="modalNewStatus">
                            <option value="pending">معلق</option>
                            <option value="processing">قيد المعالجة</option>
                            <option value="shipped">تم الشحن</option>
                            <option value="delivered">تم التسليم</option>
                            <option value="cancelled">ملغي</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ملاحظات (اختياري):</label>
                        <textarea class="form-control" id="modalStatusNotes" rows="3" placeholder="أضف ملاحظات حول تغيير الحالة..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrderStatus()">
                        <i class="fas fa-save me-2"></i>
                        حفظ التغييرات
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    // Settings functions
    function saveSettings() {
        const settings = {
            sync: {
                autoSync: document.getElementById('autoSync').checked,
                sheetsUrl: document.getElementById('sheetsUrl').value
            },
            ui: {
                language: document.getElementById('language').value,
                darkMode: document.getElementById('darkMode').checked
            }
        };
        
        localStorage.setItem('dashboardSettings', JSON.stringify(settings));
        showAlert('success', 'تم حفظ الإعدادات');
        applySettings(settings);
    }
    
    function loadSettings() {
        const savedSettings = localStorage.getItem('dashboardSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            
            document.getElementById('autoSync').checked = settings.sync?.autoSync !== false;
            document.getElementById('sheetsUrl').value = settings.sync?.sheetsUrl || '';
            document.getElementById('language').value = settings.ui?.language || 'ar';
            document.getElementById('darkMode').checked = settings.ui?.darkMode || false;
            
            applySettings(settings);
        }
    }
    
    function applySettings(settings) {
        if (settings.ui?.darkMode) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
        
        if (settings.ui?.language === 'en') {
            document.documentElement.setAttribute('dir', 'ltr');
            document.documentElement.setAttribute('lang', 'en');
        } else {
            document.documentElement.setAttribute('dir', 'rtl');
            document.documentElement.setAttribute('lang', 'ar');
        }
    }
    
    function resetSettings() {
        if (confirm('هل أنت متأكد من إعادة تعيين الإعدادات؟')) {
            localStorage.removeItem('dashboardSettings');
            location.reload();
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
    });
</script>
</body>
</html>
